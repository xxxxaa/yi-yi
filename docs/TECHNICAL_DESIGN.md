# YiYi æŠ€æœ¯è®¾è®¡æ–‡æ¡£

## ä¸€ã€ç‰©æ–™è§£æç³»ç»Ÿ

### 1.1 è§£ææµç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç‰©æ–™ä¸Šä¼ å…¥å£                            â”‚
â”‚         æ‹–æ‹½ä¸Šä¼  / æ–‡ä»¶é€‰æ‹© / æ‰¹é‡å¯¼å…¥                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ–‡ä»¶é¢„å¤„ç†                              â”‚
â”‚  - æ ¼å¼æ£€æµ‹                                                 â”‚
â”‚  - æ–‡ä»¶æ ¡éªŒ                                                 â”‚
â”‚  - ä¸´æ—¶å­˜å‚¨                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç±»å‹è·¯ç”±å™¨                              â”‚
â”‚  æ ¹æ®æ–‡ä»¶ç±»å‹åˆ†å‘åˆ°å¯¹åº”çš„è§£æå™¨                              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚         â”‚         â”‚         â”‚         â”‚
     â–¼         â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PDFè§£æ â”‚â”‚å›¾ç‰‡è§£æâ”‚â”‚è§†é¢‘è§£æâ”‚â”‚éŸ³é¢‘è§£æâ”‚â”‚è¡¨æ ¼è§£æâ”‚
â”‚  å™¨    â”‚â”‚  å™¨    â”‚â”‚  å™¨    â”‚â”‚  å™¨    â”‚â”‚  å™¨    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚         â”‚         â”‚         â”‚         â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI ä¿¡æ¯æå–                               â”‚
â”‚  - ç»“æ„åŒ–ä¿¡æ¯æå–                                           â”‚
â”‚  - å–ç‚¹è¯†åˆ«                                                 â”‚
â”‚  - å…³é”®æ•°æ®æŠ½å–                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å­˜å‚¨                                  â”‚
â”‚  - æ–‡ä»¶å­˜å‚¨                                                 â”‚
â”‚  - ç»“æ„åŒ–æ•°æ®å…¥åº“                                           â”‚
â”‚  - å‘é‡ç´¢å¼•æ„å»º                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å„ç±»å‹è§£æå™¨è¯¦ç»†è®¾è®¡

#### 1.2.1 PDFè§£æå™¨

**è¾“å…¥**: PDFæ–‡ä»¶ï¼ˆæ¥¼ä¹¦ã€æˆ·å‹å†Œã€ä»·æ ¼è¡¨ç­‰ï¼‰

**å¤„ç†æµç¨‹**:
```
1. PDFè§£æ
   - ä½¿ç”¨ pdf-parse æå–æ–‡æœ¬
   - ä½¿ç”¨ pdf2pic æå–å›¾ç‰‡
   - è¯†åˆ«è¡¨æ ¼ç»“æ„

2. å†…å®¹åˆ†ç±»
   - å°é¢ä¿¡æ¯
   - æ¥¼ç›˜ä»‹ç»
   - æˆ·å‹é¡µé¢
   - é…å¥—è¯´æ˜
   - ä»·æ ¼ä¿¡æ¯

3. AIæå–
   - å‘é€ç»™Claudeè¿›è¡Œç»“æ„åŒ–æå–
   - è¿”å›JSONæ ¼å¼æ•°æ®
```

**è¾“å‡ºç»“æ„**:
```json
{
  "document_type": "æ¥¼ä¹¦",
  "project_info": {
    "name": "xxxèŠ±å›­",
    "developer": "xxxåœ°äº§",
    "address": "xxxè·¯xxxå·"
  },
  "house_types": [
    {
      "name": "Aæˆ·å‹",
      "rooms": 3,
      "area": "89-95ã¡",
      "features": ["å—åŒ—é€šé€", "ä¸»å§å¸¦é£˜çª—"]
    }
  ],
  "facilities": {
    "traffic": ["åœ°é“xå·çº¿xxxç«™"],
    "education": ["xxxå°å­¦"],
    "commercial": ["xxxå•†åœº"]
  },
  "images": [
    {"type": "æ•ˆæœå›¾", "path": "xxx.jpg"},
    {"type": "æˆ·å‹å›¾", "path": "xxx.jpg"}
  ]
}
```

#### 1.2.2 å›¾ç‰‡è§£æå™¨

**è¾“å…¥**: JPG/PNGå›¾ç‰‡ï¼ˆæˆ·å‹å›¾ã€æ•ˆæœå›¾ã€åŒºä½å›¾ç­‰ï¼‰

**å¤„ç†æµç¨‹**:
```
1. å›¾ç‰‡åˆ†ç±»ï¼ˆAIè§†è§‰è¯†åˆ«ï¼‰
   - æˆ·å‹å›¾ â†’ æˆ·å‹è§£ææµç¨‹
   - æ•ˆæœå›¾ â†’ åœºæ™¯æ ‡ç­¾æå–
   - åŒºä½å›¾ â†’ é…å¥—ä¿¡æ¯æå–
   - ä»·æ ¼è¡¨å›¾ç‰‡ â†’ OCR+è¡¨æ ¼è§£æ

2. æˆ·å‹å›¾è§£æ
   - OCRè¯†åˆ«æ–‡å­—ï¼ˆé¢ç§¯ã€æœå‘ã€æˆ¿é—´æ ‡æ³¨ï¼‰
   - è¯†åˆ«æˆ¿é—´å¸ƒå±€
   - æå–æˆ·å‹ç‰¹ç‚¹

3. æ•ˆæœå›¾è§£æ
   - åœºæ™¯è¯†åˆ«ï¼ˆå®¢å…/å§å®¤/å¤–ç«‹é¢ç­‰ï¼‰
   - é£æ ¼è¯†åˆ«ï¼ˆç°ä»£/ä¸­å¼/æ¬§å¼ç­‰ï¼‰
   - ç”Ÿæˆæè¿°æ ‡ç­¾

4. åŒºä½å›¾è§£æ
   - OCRè¯†åˆ«åœ°æ ‡åç§°
   - è¯†åˆ«è·ç¦»ä¿¡æ¯
   - æå–é…å¥—åˆ—è¡¨
```

**æˆ·å‹å›¾è¾“å‡º**:
```json
{
  "image_type": "æˆ·å‹å›¾",
  "house_type": {
    "layout": "3å®¤2å…2å«",
    "area": "95ã¡",
    "orientation": "å—åŒ—",
    "rooms": [
      {"name": "ä¸»å§", "area": "15ã¡", "features": ["æœå—", "å¸¦é£˜çª—"]},
      {"name": "å®¢å…", "area": "28ã¡", "features": ["æœå—", "è¿æ¥é˜³å°"]}
    ],
    "highlights": ["å—åŒ—é€šé€", "åŠ¨é™åˆ†ç¦»", "å…¨æ˜æˆ·å‹"]
  }
}
```

#### 1.2.3 è§†é¢‘è§£æå™¨

**è¾“å…¥**: MP4/MOVè§†é¢‘ï¼ˆæ ·æ¿é—´è§†é¢‘ã€å®£ä¼ ç‰‡ç­‰ï¼‰

**å¤„ç†æµç¨‹**:
```
1. è§†é¢‘é¢„å¤„ç†
   - æå–éŸ³é¢‘è½¨é“
   - æŒ‰é—´éš”æå–å…³é”®å¸§ï¼ˆæ¯5ç§’ï¼‰

2. éŸ³é¢‘å¤„ç†
   - Whisperè¯­éŸ³è½¬æ–‡å­—
   - æå–è§£è¯´è¯å†…å®¹

3. å…³é”®å¸§åˆ†æ
   - åœºæ™¯è¯†åˆ«
   - æ–‡å­—OCR
   - ç”Ÿæˆå¸§æè¿°

4. å†…å®¹æ•´åˆ
   - æ—¶é—´è½´å¯¹é½
   - ç”Ÿæˆè§†é¢‘æ‘˜è¦
```

**è¾“å‡ºç»“æ„**:
```json
{
  "duration": "3:25",
  "transcript": "æ¬¢è¿æ¥åˆ°xxxèŠ±å›­æ ·æ¿é—´...",
  "scenes": [
    {"time": "0:00-0:30", "scene": "å¤–ç«‹é¢", "description": "ç°ä»£ç®€çº¦é£æ ¼å¤–ç«‹é¢"},
    {"time": "0:30-1:20", "scene": "å®¢å…", "description": "æŒ‘é«˜å®¢å…ï¼Œè½åœ°çª—è®¾è®¡"}
  ],
  "key_points": [
    "ç²¾è£…äº¤ä»˜",
    "270Â°ç¯å¹•å®¢å…",
    "ä¸»å§å¥—æˆ¿è®¾è®¡"
  ]
}
```

#### 1.2.4 è¡¨æ ¼è§£æå™¨

**è¾“å…¥**: Excel/CSV/å›¾ç‰‡è¡¨æ ¼ï¼ˆä»·æ ¼è¡¨ã€æˆ¿æºè¡¨ç­‰ï¼‰

**å¤„ç†æµç¨‹**:
```
1. æ ¼å¼å¤„ç†
   - Excel: xlsxåº“ç›´æ¥è§£æ
   - å›¾ç‰‡: OCR + è¡¨æ ¼ç»“æ„è¯†åˆ«

2. è¡¨æ ¼ç»“æ„åŒ–
   - è¯†åˆ«è¡¨å¤´
   - è§£ææ•°æ®è¡Œ
   - æ•°æ®ç±»å‹æ¨æ–­

3. è¯­ä¹‰ç†è§£
   - AIç†è§£è¡¨æ ¼å«ä¹‰
   - å­—æ®µæ˜ å°„åˆ°æ ‡å‡†ç»“æ„
```

**ä»·æ ¼è¡¨è¾“å‡º**:
```json
{
  "table_type": "ä»·æ ¼è¡¨",
  "update_date": "2026-02-01",
  "units": [
    {
      "building": "1æ ‹",
      "unit": "1å•å…ƒ",
      "floor": 15,
      "room": "1501",
      "house_type": "Aæˆ·å‹",
      "area": 95.5,
      "unit_price": 25000,
      "total_price": 2387500,
      "status": "åœ¨å”®"
    }
  ]
}
```

### 1.3 AIæå–Promptè®¾è®¡

#### æ¥¼ç›˜ä¿¡æ¯æå–Prompt

```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æˆ¿äº§ä¿¡æ¯æå–åŠ©æ‰‹ã€‚è¯·ä»ä»¥ä¸‹å†…å®¹ä¸­æå–æ¥¼ç›˜ä¿¡æ¯ï¼Œä»¥JSONæ ¼å¼è¿”å›ã€‚

éœ€è¦æå–çš„ä¿¡æ¯ï¼š
1. æ¥¼ç›˜åŸºç¡€ä¿¡æ¯ï¼ˆåç§°ã€å¼€å‘å•†ã€åœ°å€ã€ç‰©ä¸šç±»å‹ã€äº§æƒå¹´é™ã€äº¤æˆ¿æ—¶é—´ï¼‰
2. æˆ·å‹ä¿¡æ¯ï¼ˆæˆ·å‹åç§°ã€é¢ç§¯ã€æœå‘ã€ä»·æ ¼ã€ç‰¹ç‚¹ï¼‰
3. é…å¥—ä¿¡æ¯ï¼ˆäº¤é€šã€æ•™è‚²ã€å•†ä¸šã€åŒ»ç–—ã€ä¼‘é—²ï¼‰
4. æ ¸å¿ƒå–ç‚¹ï¼ˆ3-5ä¸ªæœ€çªå‡ºçš„å–ç‚¹ï¼‰

å¦‚æœæŸé¡¹ä¿¡æ¯æœªæåŠï¼Œè¿”å›nullã€‚

å†…å®¹ï¼š
{content}

è¯·è¿”å›JSONæ ¼å¼ï¼š
```

#### æˆ·å‹å›¾è§£æPrompt

```
è¯·åˆ†æè¿™å¼ æˆ·å‹å›¾ï¼Œæå–ä»¥ä¸‹ä¿¡æ¯ï¼š

1. æˆ·å‹å¸ƒå±€ï¼ˆå‡ å®¤å‡ å…å‡ å«ï¼‰
2. å»ºç­‘é¢ç§¯
3. æœå‘
4. å„æˆ¿é—´ä¿¡æ¯ï¼ˆåç§°ã€å¤§æ¦‚é¢ç§¯ã€ç‰¹ç‚¹ï¼‰
5. æˆ·å‹äº®ç‚¹ï¼ˆå¦‚å—åŒ—é€šé€ã€åŠ¨é™åˆ†ç¦»ç­‰ï¼‰

ä»¥JSONæ ¼å¼è¿”å›ç»“æœã€‚
```

---

## äºŒã€å†…å®¹ç”Ÿæˆç³»ç»Ÿ

### 2.1 ç”Ÿæˆæµç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·è¾“å…¥                                â”‚
â”‚  é€‰æ‹©æ¥¼ç›˜ â†’ é€‰æ‹©å†…å®¹ç±»å‹ â†’ é…ç½®å‚æ•°                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç‰©æ–™æ£€ç´¢                                  â”‚
â”‚  - åŠ è½½æ¥¼ç›˜åŸºç¡€ä¿¡æ¯                                         â”‚
â”‚  - æ£€ç´¢ç›¸å…³ç‰©æ–™                                             â”‚
â”‚  - æ„å»ºä¸Šä¸‹æ–‡                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Promptæ„å»º                                â”‚
â”‚  - é€‰æ‹©å¯¹åº”æ¨¡æ¿                                             â”‚
â”‚  - æ³¨å…¥æ¥¼ç›˜ä¿¡æ¯                                             â”‚
â”‚  - åº”ç”¨é£æ ¼å‚æ•°                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AIç”Ÿæˆ                                    â”‚
â”‚  - è°ƒç”¨Claude API                                           â”‚
â”‚  - æµå¼è¾“å‡º                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åå¤„ç†                                    â”‚
â”‚  - æ ¼å¼åŒ–è¾“å‡º                                               â”‚
â”‚  - æ•æ„Ÿè¯æ£€æŸ¥                                               â”‚
â”‚  - ä¿å­˜è®°å½•                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å†…å®¹æ¨¡æ¿è®¾è®¡

#### 2.2.1 å°çº¢ä¹¦æ¨æ–‡æ¨¡æ¿

**æ¨¡æ¿ç»“æ„**:
```yaml
template_id: xiaohongshu_tanpan
name: æ¢ç›˜ç¬”è®°
description: ä»¥ç¬¬ä¸€äººç§°æ¢ç›˜è§†è§’çš„ç§è‰ç¬”è®°

structure:
  title:
    format: "emoji + å¸ç›æ ‡é¢˜"
    max_length: 20
    examples:
      - "ğŸ å‘ç°å®è—æ¥¼ç›˜ï¼{area}åˆšéœ€ç¦éŸ³"
      - "ğŸ’°æ€»ä»·{price}ä¸‡ä¸Šè½¦{city}åœ°é“æˆ¿"

  body:
    sections:
      - name: å¼€åœº
        description: å¼•å…¥è¯é¢˜ï¼Œåˆ¶é€ å¥½å¥‡
        length: 50-100å­—

      - name: æ¥¼ç›˜ä»‹ç»
        description: ä½ç½®ã€å¼€å‘å•†ã€åŸºæœ¬ä¿¡æ¯
        length: 100-150å­—

      - name: æˆ·å‹åˆ†æ
        description: ä¸»æ¨æˆ·å‹è¯¦ç»†ä»‹ç»
        length: 150-200å­—

      - name: é…å¥—è¯´æ˜
        description: äº¤é€šã€å­¦æ ¡ã€å•†ä¸šç­‰
        length: 100-150å­—

      - name: ä»·æ ¼ä¿¡æ¯
        description: ä»·æ ¼åŒºé—´ã€æ€§ä»·æ¯”åˆ†æ
        length: 50-100å­—

      - name: æ€»ç»“å»ºè®®
        description: é€‚åˆäººç¾¤ã€è´­ä¹°å»ºè®®
        length: 50-100å­—

  tags:
    count: 5-10
    categories:
      - åŸå¸‚æ ‡ç­¾: "#ä¸Šæµ·ä¹°æˆ¿"
      - åŒºåŸŸæ ‡ç­¾: "#æµ¦ä¸œæ–°æˆ¿"
      - éœ€æ±‚æ ‡ç­¾: "#åˆšéœ€ä¸Šè½¦"
      - äº§å“æ ‡ç­¾: "#åœ°é“æˆ¿"
```

**ç”ŸæˆPrompt**:
```
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æˆ¿äº§åšä¸»ï¼Œæ“…é•¿å†™å°çº¢ä¹¦ç§è‰ç¬”è®°ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ¥¼ç›˜ä¿¡æ¯ï¼Œå†™ä¸€ç¯‡æ¢ç›˜ç¬”è®°ã€‚

## æ¥¼ç›˜ä¿¡æ¯
{project_info}

## å†™ä½œè¦æ±‚
1. æ ‡é¢˜è¦å¸ç›ï¼ŒåŒ…å«emojiï¼Œçªå‡ºæ ¸å¿ƒå–ç‚¹
2. æ­£æ–‡800-1200å­—ï¼Œåˆ†æ®µæ¸…æ™°
3. è¯­æ°”äº²åˆ‡è‡ªç„¶ï¼Œåƒæœ‹å‹åˆ†äº«
4. çªå‡ºä»¥ä¸‹å–ç‚¹ï¼š{highlights}
5. ç›®æ ‡è¯»è€…ï¼š{target_audience}
6. é£æ ¼ï¼š{style}

## è¾“å‡ºæ ¼å¼
æ ‡é¢˜ï¼šxxx
æ­£æ–‡ï¼šxxx
æ ‡ç­¾ï¼š#xxx #xxx

è¯·å¼€å§‹åˆ›ä½œï¼š
```

#### 2.2.2 çŸ­è§†é¢‘è„šæœ¬æ¨¡æ¿

**æ¨¡æ¿ç»“æ„**:
```yaml
template_id: video_script_30s
name: 30ç§’æ¥¼ç›˜ä»‹ç»
description: é€‚åˆæŠ–éŸ³/è§†é¢‘å·çš„çŸ­è§†é¢‘è„šæœ¬

structure:
  duration: 30s

  scenes:
    - name: å¼€åœºhook
      duration: 3-5s
      content: å¸å¼•æ³¨æ„åŠ›çš„å¼€åœºç™½
      visual: å¤–ç«‹é¢/èˆªæ‹

    - name: æ¥¼ç›˜å®šä½
      duration: 5-8s
      content: æ¥¼ç›˜åç§°ã€ä½ç½®ã€å¼€å‘å•†
      visual: åŒºä½å›¾/æ²™ç›˜

    - name: æ ¸å¿ƒå–ç‚¹
      duration: 10-12s
      content: 2-3ä¸ªæ ¸å¿ƒå–ç‚¹
      visual: é…å¥—å®æ™¯/æ•ˆæœå›¾

    - name: æˆ·å‹ä»·æ ¼
      duration: 5-8s
      content: ä¸»åŠ›æˆ·å‹å’Œä»·æ ¼
      visual: æˆ·å‹å›¾/æ ·æ¿é—´

    - name: ç»“å°¾å¼•å¯¼
      duration: 3-5s
      content: è¡ŒåŠ¨å·å¬
      visual: è”ç³»æ–¹å¼/äºŒç»´ç 

output_format:
  script: å®Œæ•´å£æ’­æ–‡æ¡ˆ
  subtitles: åˆ†æ®µå­—å¹•
  shot_list: åˆ†é•œå»ºè®®
  bgm_suggestion: èƒŒæ™¯éŸ³ä¹å»ºè®®
```

**ç”ŸæˆPrompt**:
```
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æˆ¿äº§çŸ­è§†é¢‘ç¼–å¯¼ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ¥¼ç›˜ä¿¡æ¯ï¼Œåˆ›ä½œä¸€ä¸ª{duration}ç§’çš„çŸ­è§†é¢‘è„šæœ¬ã€‚

## æ¥¼ç›˜ä¿¡æ¯
{project_info}

## è§†é¢‘è¦æ±‚
1. æ—¶é•¿ï¼š{duration}ç§’
2. å¹³å°ï¼š{platform}
3. é£æ ¼ï¼š{style}
4. çªå‡ºå–ç‚¹ï¼š{highlights}

## è¾“å‡ºæ ¼å¼

### å£æ’­æ–‡æ¡ˆ
ï¼ˆå®Œæ•´çš„å£æ’­ç¨¿ï¼Œæ ‡æ³¨æ—¶é—´èŠ‚ç‚¹ï¼‰

### åˆ†é•œè„šæœ¬
| æ—¶é—´ | ç”»é¢ | å£æ’­ | å­—å¹• |
|------|------|------|------|

### æ‹æ‘„å»ºè®®
- åœºæ™¯1ï¼šxxx
- åœºæ™¯2ï¼šxxx

### BGMå»ºè®®
é£æ ¼ï¼šxxx
å‚è€ƒæ›²ç›®ï¼šxxx

è¯·å¼€å§‹åˆ›ä½œï¼š
```

#### 2.2.3 æœ‹å‹åœˆæ–‡æ¡ˆæ¨¡æ¿

**æ¨¡æ¿ç»“æ„**:
```yaml
template_id: moments_recommend
name: æˆ¿æºæ¨è
description: æœ‹å‹åœˆæˆ¿æºæ¨èæ–‡æ¡ˆ

structure:
  text:
    max_length: 200
    format: |
      ã€æ¥¼ç›˜åç§°ã€‘ç®€çŸ­ä»‹ç»
      ğŸ“ä½ç½®ï¼šxxx
      ğŸ æˆ·å‹ï¼šxxx
      ğŸ’°ä»·æ ¼ï¼šxxx
      âœ¨äº®ç‚¹ï¼šxxx

  images:
    count: 6-9
    order:
      - æ•ˆæœå›¾ï¼ˆå°é¢ï¼‰
      - åŒºä½å›¾
      - æˆ·å‹å›¾x2
      - æ ·æ¿é—´x3
      - é…å¥—å®æ™¯
```

### 2.3 é£æ ¼å‚æ•°é…ç½®

```typescript
interface ContentStyle {
  // è¯­æ°”é£æ ¼
  tone: 'professional' | 'casual' | 'enthusiastic' | 'informative';

  // ç›®æ ‡å—ä¼—
  audience: 'first_time_buyer' | 'upgrader' | 'investor' | 'elderly';

  // å†…å®¹ä¾§é‡
  focus: 'price' | 'location' | 'quality' | 'education' | 'investment';

  // æ˜¯å¦åŒ…å«ä»·æ ¼
  includePrice: boolean;

  // emojiä½¿ç”¨ç¨‹åº¦
  emojiLevel: 'none' | 'minimal' | 'moderate' | 'heavy';

  // æ–‡æ¡ˆé•¿åº¦
  length: 'short' | 'medium' | 'long';
}
```

### 2.4 å†…å®¹è´¨é‡æ§åˆ¶

#### æ•æ„Ÿè¯è¿‡æ»¤
```typescript
const sensitiveWords = [
  // è¿è§„æ‰¿è¯º
  'ä¿å€¼', 'å¢å€¼', 'æŠ•èµ„å›æŠ¥', 'ç¨³èµš',
  // è™šå‡å®£ä¼ 
  'ç¬¬ä¸€', 'æœ€å¥½', 'ç»æ— ä»…æœ‰', 'ç‹¬ä¸€æ— äºŒ',
  // å…¶ä»–æ•æ„Ÿè¯
  'å­¦åŒºæˆ¿', 'åœ°é“æˆ¿'  // éœ€è¦æ ¸å®åä½¿ç”¨
];
```

#### å†…å®¹å®¡æ ¸æµç¨‹
```
ç”Ÿæˆå†…å®¹ â†’ æ•æ„Ÿè¯æ£€æŸ¥ â†’ äº‹å®æ ¸å¯¹ â†’ äººå·¥ç¡®è®¤ â†’ å‘å¸ƒ
```

---

## ä¸‰ã€æ•°æ®æµè®¾è®¡

### 3.1 ç‰©æ–™ä¸Šä¼ æ•°æ®æµ

```typescript
// ä¸Šä¼ è¯·æ±‚
interface UploadRequest {
  projectId: string;
  files: File[];
}

// è§£æä»»åŠ¡
interface ParseTask {
  id: string;
  fileId: string;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  progress: number;
  result?: ParseResult;
  error?: string;
}

// è§£æç»“æœ
interface ParseResult {
  fileType: string;
  category: string;
  extractedData: Record<string, any>;
  confidence: number;
}
```

### 3.2 å†…å®¹ç”Ÿæˆæ•°æ®æµ

```typescript
// ç”Ÿæˆè¯·æ±‚
interface GenerateRequest {
  projectId: string;
  contentType: 'xiaohongshu' | 'video_script' | 'moments';
  template?: string;
  style: ContentStyle;
  highlights?: string[];
}

// ç”Ÿæˆå“åº”ï¼ˆæµå¼ï¼‰
interface GenerateResponse {
  id: string;
  status: 'generating' | 'completed';
  content: string;  // å¢é‡å†…å®¹
  metadata?: {
    title?: string;
    tags?: string[];
    images?: string[];
  };
}
```

---

## å››ã€APIè®¾è®¡

### 4.1 ç‰©æ–™ç®¡ç†API

```typescript
// ä¸Šä¼ ç‰©æ–™
POST /api/projects/{projectId}/materials
Body: FormData (files)
Response: { taskIds: string[] }

// æŸ¥è¯¢è§£æçŠ¶æ€
GET /api/materials/tasks/{taskId}
Response: ParseTask

// è·å–ç‰©æ–™åˆ—è¡¨
GET /api/projects/{projectId}/materials
Query: { type?, category?, page?, limit? }
Response: { materials: Material[], total: number }

// æ›´æ–°ç‰©æ–™ä¿¡æ¯
PATCH /api/materials/{materialId}
Body: { category?, parsedContent? }

// åˆ é™¤ç‰©æ–™
DELETE /api/materials/{materialId}
```

### 4.2 å†…å®¹ç”ŸæˆAPI

```typescript
// ç”Ÿæˆå†…å®¹
POST /api/projects/{projectId}/generate
Body: GenerateRequest
Response: SSE stream of GenerateResponse

// è·å–ç”Ÿæˆå†å²
GET /api/projects/{projectId}/contents
Query: { type?, page?, limit? }
Response: { contents: GeneratedContent[], total: number }

// é‡æ–°ç”Ÿæˆ
POST /api/contents/{contentId}/regenerate
Body: { style?: ContentStyle }
Response: SSE stream of GenerateResponse
```

---

## äº”ã€æŠ€æœ¯å®ç°è¦ç‚¹

### 5.1 å¤§æ–‡ä»¶å¤„ç†

```typescript
// åˆ†ç‰‡ä¸Šä¼ 
const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB

async function uploadLargeFile(file: File, projectId: string) {
  const chunks = Math.ceil(file.size / CHUNK_SIZE);
  const uploadId = await initMultipartUpload(projectId, file.name);

  for (let i = 0; i < chunks; i++) {
    const chunk = file.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
    await uploadChunk(uploadId, i, chunk);
  }

  return await completeUpload(uploadId);
}
```

### 5.2 è§£æä»»åŠ¡é˜Ÿåˆ—

```typescript
// ä½¿ç”¨é˜Ÿåˆ—å¤„ç†è§£æä»»åŠ¡ï¼Œé¿å…é˜»å¡
class ParseQueue {
  private queue: ParseTask[] = [];
  private processing = false;

  async add(task: ParseTask) {
    this.queue.push(task);
    if (!this.processing) {
      this.process();
    }
  }

  private async process() {
    this.processing = true;
    while (this.queue.length > 0) {
      const task = this.queue.shift()!;
      await this.executeTask(task);
    }
    this.processing = false;
  }
}
```

### 5.3 æµå¼å†…å®¹ç”Ÿæˆ

```typescript
// ä½¿ç”¨SSEå®ç°æµå¼è¾“å‡º
async function* generateContent(request: GenerateRequest) {
  const context = await buildContext(request.projectId);
  const prompt = buildPrompt(request, context);

  const stream = await claude.messages.create({
    model: 'claude-sonnet-4-20250514',
    messages: [{ role: 'user', content: prompt }],
    stream: true
  });

  for await (const chunk of stream) {
    yield {
      status: 'generating',
      content: chunk.delta?.text || ''
    };
  }

  yield { status: 'completed', content: '' };
}
```

---

## å…­ã€å¤šæ¨¡å‹é€‚é…ç³»ç»Ÿ

å‚è€ƒ OpenClaw é¡¹ç›®çš„å¤šæ¨¡å‹æ¶æ„è®¾è®¡ï¼ŒYiYi æ”¯æŒå¤šç§ AI æ¨¡å‹æä¾›å•†ï¼Œå¹¶å…·å¤‡æ™ºèƒ½æ•…éšœè½¬ç§»èƒ½åŠ›ã€‚

### 6.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨å±‚                                  â”‚
â”‚         ç‰©æ–™è§£æ / å†…å®¹ç”Ÿæˆ / æ™ºèƒ½é—®ç­”                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ¨¡å‹è·¯ç”±å±‚                                 â”‚
â”‚  - æ¨¡å‹é€‰æ‹©                                                 â”‚
â”‚  - æ•…éšœè½¬ç§»                                                 â”‚
â”‚  - è´Ÿè½½å‡è¡¡                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Anthropic   â”‚  â”‚   OpenAI     â”‚  â”‚   å…¶ä»–æä¾›å•†  â”‚
â”‚  Claudeç³»åˆ—  â”‚  â”‚   GPTç³»åˆ—    â”‚  â”‚  Gemini/é€šä¹‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æ”¯æŒçš„æ¨¡å‹æä¾›å•†

| æä¾›å•† | æ¨¡å‹ | APIç±»å‹ | é€‚ç”¨åœºæ™¯ |
|--------|------|---------|----------|
| **Anthropic** | Claude 3.5/4 | anthropic-messages | ä¸»åŠ›æ¨¡å‹ï¼Œå†…å®¹ç”Ÿæˆ |
| **OpenAI** | GPT-4/4o | openai-completions | å¤‡ç”¨æ¨¡å‹ |
| **Google** | Gemini Pro | google-generative-ai | å¤šæ¨¡æ€è§£æ |
| **é˜¿é‡Œäº‘** | é€šä¹‰åƒé—® | openai-compatible | å›½å†…å¤‡ç”¨ |
| **æœ¬åœ°æ¨¡å‹** | Ollama/LMStudio | openai-compatible | ç¦»çº¿ä½¿ç”¨ |

### 6.3 é…ç½®ç»“æ„è®¾è®¡

#### æ¨¡å‹é…ç½®

```typescript
interface ModelConfig {
  // ä¸»æ¨¡å‹é…ç½®
  model: {
    primary: string;        // ä¸»æ¨¡å‹ "provider/model"
    fallbacks?: string[];   // æ•…éšœè½¬ç§»åˆ—è¡¨
  };

  // å›¾åƒå¤„ç†æ¨¡å‹ï¼ˆç”¨äºæˆ·å‹å›¾ã€æ•ˆæœå›¾è§£æï¼‰
  imageModel?: {
    primary: string;
    fallbacks?: string[];
  };

  // æ¨¡å‹ç›®å½•ï¼ˆå¯é…ç½®åˆ«åå’Œå‚æ•°ï¼‰
  models?: {
    [key: string]: {
      alias?: string;       // åˆ«åï¼Œå¦‚ "fast", "smart"
      params?: {            // æ¨¡å‹ç‰¹å®šå‚æ•°
        temperature?: number;
        maxTokens?: number;
      };
    };
  };
}
```

#### æä¾›å•†é…ç½®

```typescript
interface ProviderConfig {
  [providerId: string]: {
    baseUrl: string;                    // APIç«¯ç‚¹
    apiKey?: string;                    // APIå¯†é’¥
    auth: 'api-key' | 'oauth' | 'token'; // è®¤è¯æ–¹å¼
    api: ModelApi;                      // APIç±»å‹
    headers?: Record<string, string>;   // è‡ªå®šä¹‰è¯·æ±‚å¤´
    models: ModelDefinition[];          // æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨
  };
}

type ModelApi =
  | 'openai-completions'      // OpenAI å…¼å®¹
  | 'anthropic-messages'      // Anthropic åŸç”Ÿ
  | 'google-generative-ai';   // Google AI
```

#### é…ç½®æ–‡ä»¶ç¤ºä¾‹

```json5
// ~/.yiyi/config.json
{
  // æ¨¡å‹é…ç½®
  "model": {
    "primary": "anthropic/claude-sonnet-4-20250514",
    "fallbacks": [
      "openai/gpt-4o",
      "qwen/qwen-max"
    ]
  },

  // å›¾åƒæ¨¡å‹ï¼ˆå¤šæ¨¡æ€ï¼‰
  "imageModel": {
    "primary": "anthropic/claude-sonnet-4-20250514",
    "fallbacks": ["google/gemini-pro-vision"]
  },

  // æ¨¡å‹åˆ«å
  "models": {
    "anthropic/claude-sonnet-4-20250514": { "alias": "default" },
    "anthropic/claude-3-5-haiku-20241022": { "alias": "fast" },
    "anthropic/claude-opus-4-20250514": { "alias": "smart" }
  },

  // æä¾›å•†é…ç½®
  "providers": {
    "anthropic": {
      "apiKey": "${ANTHROPIC_API_KEY}"
    },
    "openai": {
      "apiKey": "${OPENAI_API_KEY}"
    },
    "qwen": {
      "baseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1",
      "apiKey": "${QWEN_API_KEY}",
      "api": "openai-completions"
    },
    "local": {
      "baseUrl": "http://localhost:11434/v1",
      "api": "openai-completions"
    }
  }
}
```

### 6.4 æ•…éšœè½¬ç§»æœºåˆ¶

#### æ•…éšœè½¬ç§»æµç¨‹

```typescript
interface FailoverAttempt {
  provider: string;
  model: string;
  error: Error;
  reason: FailoverReason;
  timestamp: number;
}

type FailoverReason =
  | 'auth'        // è®¤è¯å¤±è´¥
  | 'rate_limit'  // é€Ÿç‡é™åˆ¶
  | 'timeout'     // è¯·æ±‚è¶…æ—¶
  | 'billing'     // è®¡è´¹é—®é¢˜
  | 'unavailable' // æœåŠ¡ä¸å¯ç”¨
  | 'unknown';    // æœªçŸ¥é”™è¯¯

async function runWithFallback<T>(
  task: (provider: string, model: string) => Promise<T>,
  config: ModelConfig
): Promise<T> {
  const candidates = [
    config.model.primary,
    ...(config.model.fallbacks || [])
  ];

  const attempts: FailoverAttempt[] = [];

  for (const candidate of candidates) {
    const [provider, model] = parseModelRef(candidate);

    // æ£€æŸ¥å†·å´çŠ¶æ€
    if (isInCooldown(provider)) {
      attempts.push({ provider, model, reason: 'cooldown', ... });
      continue;
    }

    try {
      const result = await task(provider, model);
      // è®°å½•æˆåŠŸ
      recordSuccess(provider);
      return result;
    } catch (error) {
      const reason = classifyError(error);
      attempts.push({ provider, model, error, reason, ... });

      // æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦ç»§ç»­
      if (reason === 'auth' || reason === 'billing') {
        // è®¤è¯/è®¡è´¹é—®é¢˜ï¼Œè¿›å…¥å†·å´
        setCooldown(provider, 30 * 60 * 1000); // 30åˆ†é’Ÿ
      }

      // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæ¨¡å‹
      continue;
    }
  }

  // æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥
  throw new AllModelsFailedError(attempts);
}
```

#### å†·å´æœºåˆ¶

```typescript
interface CooldownState {
  provider: string;
  until: number;        // å†·å´ç»“æŸæ—¶é—´
  reason: FailoverReason;
  failCount: number;    // è¿ç»­å¤±è´¥æ¬¡æ•°
}

// å†·å´æ—¶é—´ç­–ç•¥ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
function getCooldownDuration(failCount: number): number {
  const base = 60 * 1000; // 1åˆ†é’Ÿ
  const max = 30 * 60 * 1000; // æœ€å¤§30åˆ†é’Ÿ
  return Math.min(base * Math.pow(2, failCount - 1), max);
}
```

### 6.5 è®¤è¯ç®¡ç†

#### æ”¯æŒçš„è®¤è¯æ–¹å¼

```typescript
// 1. API Key è®¤è¯ï¼ˆæœ€å¸¸ç”¨ï¼‰
interface ApiKeyAuth {
  type: 'api-key';
  key: string;
}

// 2. OAuth è®¤è¯ï¼ˆæ”¯æŒè‡ªåŠ¨åˆ·æ–°ï¼‰
interface OAuthAuth {
  type: 'oauth';
  accessToken: string;
  refreshToken: string;
  expiresAt: number;
  clientId?: string;
}

// 3. é™æ€ Token è®¤è¯
interface TokenAuth {
  type: 'token';
  token: string;
  expiresAt?: number;
}
```

#### è®¤è¯é…ç½®å­˜å‚¨

```typescript
// ~/.yiyi/auth.jsonï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
interface AuthStore {
  version: number;
  profiles: {
    [profileId: string]: {
      provider: string;
      credential: ApiKeyAuth | OAuthAuth | TokenAuth;
      email?: string;
      createdAt: number;
      lastUsed?: number;
    };
  };
  // æ¯ä¸ªæä¾›å•†çš„è®¤è¯é¡ºåº
  order?: {
    [provider: string]: string[];
  };
}
```

#### OAuth è‡ªåŠ¨åˆ·æ–°

```typescript
async function ensureValidToken(profile: OAuthProfile): Promise<string> {
  // æ£€æŸ¥æ˜¯å¦å³å°†è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
  if (profile.expiresAt - Date.now() < 5 * 60 * 1000) {
    const newTokens = await refreshOAuthToken(profile);
    await updateAuthStore(profile.id, newTokens);
    return newTokens.accessToken;
  }
  return profile.accessToken;
}
```

### 6.6 è¿è¡Œæ—¶æ¨¡å‹åˆ‡æ¢

#### æ¨¡å‹é€‰æ‹©å™¨

```typescript
interface ModelSelector {
  // è§£ææ¨¡å‹å¼•ç”¨
  parseRef(ref: string): { provider: string; model: string };

  // é€šè¿‡åˆ«åè·å–æ¨¡å‹
  getByAlias(alias: string): ModelRef | null;

  // è·å–æ¨èæ¨¡å‹ï¼ˆæ ¹æ®ä»»åŠ¡ç±»å‹ï¼‰
  getRecommended(task: TaskType): ModelRef;

  // åˆ—å‡ºå¯ç”¨æ¨¡å‹
  listAvailable(): ModelRef[];
}

type TaskType =
  | 'content_generation'  // å†…å®¹ç”Ÿæˆ - éœ€è¦åˆ›æ„
  | 'data_extraction'     // æ•°æ®æå– - éœ€è¦å‡†ç¡®
  | 'image_analysis'      // å›¾åƒåˆ†æ - éœ€è¦å¤šæ¨¡æ€
  | 'quick_query';        // å¿«é€ŸæŸ¥è¯¢ - éœ€è¦é€Ÿåº¦
```

#### ä»»åŠ¡çº§æ¨¡å‹é…ç½®

```typescript
// ä¸åŒä»»åŠ¡ä½¿ç”¨ä¸åŒæ¨¡å‹
const taskModelMapping = {
  // å†…å®¹ç”Ÿæˆï¼šä½¿ç”¨ä¸»åŠ›æ¨¡å‹
  content_generation: 'default',

  // æ•°æ®æå–ï¼šä½¿ç”¨å‡†ç¡®æ¨¡å‹
  data_extraction: 'smart',

  // å¿«é€ŸæŸ¥è¯¢ï¼šä½¿ç”¨å¿«é€Ÿæ¨¡å‹
  quick_query: 'fast',

  // å›¾åƒåˆ†æï¼šä½¿ç”¨å¤šæ¨¡æ€æ¨¡å‹
  image_analysis: 'imageModel'
};
```

### 6.7 æ¨¡å‹ç®¡ç† API

```typescript
// è·å–å½“å‰æ¨¡å‹é…ç½®
GET /api/models/config
Response: ModelConfig

// æ›´æ–°æ¨¡å‹é…ç½®
PATCH /api/models/config
Body: Partial<ModelConfig>

// åˆ—å‡ºå¯ç”¨æ¨¡å‹
GET /api/models/available
Response: { models: ModelInfo[] }

// æµ‹è¯•æ¨¡å‹è¿æ¥
POST /api/models/test
Body: { provider: string, model: string }
Response: { success: boolean, latency: number, error?: string }

// è·å–æ¨¡å‹ä½¿ç”¨ç»Ÿè®¡
GET /api/models/stats
Response: {
  usage: { [model: string]: { calls: number, tokens: number } },
  errors: { [model: string]: { count: number, lastError: string } }
}
```

### 6.8 æœ¬åœ°æ¨¡å‹æ”¯æŒ

æ”¯æŒé€šè¿‡ Ollama æˆ– LMStudio è¿è¡Œæœ¬åœ°æ¨¡å‹ï¼Œå®ç°ç¦»çº¿ä½¿ç”¨ã€‚

```typescript
// æœ¬åœ°æ¨¡å‹é…ç½®
const localProvider: ProviderConfig = {
  local: {
    baseUrl: 'http://localhost:11434/v1',  // Ollama é»˜è®¤ç«¯å£
    api: 'openai-completions',
    models: [
      { id: 'llama3.1:8b', name: 'Llama 3.1 8B' },
      { id: 'qwen2.5:7b', name: 'Qwen 2.5 7B' },
      { id: 'llava:13b', name: 'LLaVA 13B (å¤šæ¨¡æ€)' }
    ]
  }
};

// è‡ªåŠ¨æ£€æµ‹æœ¬åœ°æ¨¡å‹
async function discoverLocalModels(): Promise<ModelInfo[]> {
  try {
    const response = await fetch('http://localhost:11434/api/tags');
    const { models } = await response.json();
    return models.map(m => ({
      id: m.name,
      provider: 'local',
      size: m.size,
      modifiedAt: m.modified_at
    }));
  } catch {
    return []; // æœ¬åœ°æœåŠ¡æœªè¿è¡Œ
  }
}
```
