# YiYi æŠ€æœ¯è®¾è®¡æ–‡æ¡£

## ä¸€ã€ç‰©æ–™è§£æç³»ç»Ÿ

### 1.1 è§£ææµç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç‰©æ–™ä¸Šä¼ å…¥å£                            â”‚
â”‚         æ‹–æ‹½ä¸Šä¼  / æ–‡ä»¶é€‰æ‹© / æ‰¹é‡å¯¼å…¥                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ–‡ä»¶é¢„å¤„ç†                              â”‚
â”‚  - æ ¼å¼æ£€æµ‹                                                 â”‚
â”‚  - æ–‡ä»¶æ ¡éªŒ                                                 â”‚
â”‚  - ä¸´æ—¶å­˜å‚¨                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç±»å‹è·¯ç”±å™¨                              â”‚
â”‚  æ ¹æ®æ–‡ä»¶ç±»å‹åˆ†å‘åˆ°å¯¹åº”çš„è§£æå™¨                              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚         â”‚         â”‚         â”‚         â”‚
     â–¼         â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PDFè§£æ â”‚â”‚å›¾ç‰‡è§£æâ”‚â”‚è§†é¢‘è§£æâ”‚â”‚éŸ³é¢‘è§£æâ”‚â”‚è¡¨æ ¼è§£æâ”‚
â”‚  å™¨    â”‚â”‚  å™¨    â”‚â”‚  å™¨    â”‚â”‚  å™¨    â”‚â”‚  å™¨    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚         â”‚         â”‚         â”‚         â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI ä¿¡æ¯æå–                               â”‚
â”‚  - ç»“æ„åŒ–ä¿¡æ¯æå–                                           â”‚
â”‚  - å–ç‚¹è¯†åˆ«                                                 â”‚
â”‚  - å…³é”®æ•°æ®æŠ½å–                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å­˜å‚¨                                  â”‚
â”‚  - æ–‡ä»¶å­˜å‚¨                                                 â”‚
â”‚  - ç»“æ„åŒ–æ•°æ®å…¥åº“                                           â”‚
â”‚  - å‘é‡ç´¢å¼•æ„å»º                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å„ç±»å‹è§£æå™¨è¯¦ç»†è®¾è®¡

#### 1.2.1 PDFè§£æå™¨

**è¾“å…¥**: PDFæ–‡ä»¶ï¼ˆæ¥¼ä¹¦ã€æˆ·å‹å†Œã€ä»·æ ¼è¡¨ç­‰ï¼‰

**å¤„ç†æµç¨‹**:
```
1. PDFè§£æ
   - ä½¿ç”¨ pdf-parse æå–æ–‡æœ¬
   - ä½¿ç”¨ pdf2pic æå–å›¾ç‰‡
   - è¯†åˆ«è¡¨æ ¼ç»“æ„

2. å†…å®¹åˆ†ç±»
   - å°é¢ä¿¡æ¯
   - æ¥¼ç›˜ä»‹ç»
   - æˆ·å‹é¡µé¢
   - é…å¥—è¯´æ˜
   - ä»·æ ¼ä¿¡æ¯

3. AIæå–
   - å‘é€ç»™Claudeè¿›è¡Œç»“æ„åŒ–æå–
   - è¿”å›JSONæ ¼å¼æ•°æ®
```

**è¾“å‡ºç»“æ„**:
```json
{
  "document_type": "æ¥¼ä¹¦",
  "project_info": {
    "name": "xxxèŠ±å›­",
    "developer": "xxxåœ°äº§",
    "address": "xxxè·¯xxxå·"
  },
  "house_types": [
    {
      "name": "Aæˆ·å‹",
      "rooms": 3,
      "area": "89-95ã¡",
      "features": ["å—åŒ—é€šé€", "ä¸»å§å¸¦é£˜çª—"]
    }
  ],
  "facilities": {
    "traffic": ["åœ°é“xå·çº¿xxxç«™"],
    "education": ["xxxå°å­¦"],
    "commercial": ["xxxå•†åœº"]
  },
  "images": [
    {"type": "æ•ˆæœå›¾", "path": "xxx.jpg"},
    {"type": "æˆ·å‹å›¾", "path": "xxx.jpg"}
  ]
}
```

#### 1.2.2 å›¾ç‰‡è§£æå™¨

**è¾“å…¥**: JPG/PNGå›¾ç‰‡ï¼ˆæˆ·å‹å›¾ã€æ•ˆæœå›¾ã€åŒºä½å›¾ç­‰ï¼‰

**å¤„ç†æµç¨‹**:
```
1. å›¾ç‰‡åˆ†ç±»ï¼ˆAIè§†è§‰è¯†åˆ«ï¼‰
   - æˆ·å‹å›¾ â†’ æˆ·å‹è§£ææµç¨‹
   - æ•ˆæœå›¾ â†’ åœºæ™¯æ ‡ç­¾æå–
   - åŒºä½å›¾ â†’ é…å¥—ä¿¡æ¯æå–
   - ä»·æ ¼è¡¨å›¾ç‰‡ â†’ OCR+è¡¨æ ¼è§£æ

2. æˆ·å‹å›¾è§£æ
   - OCRè¯†åˆ«æ–‡å­—ï¼ˆé¢ç§¯ã€æœå‘ã€æˆ¿é—´æ ‡æ³¨ï¼‰
   - è¯†åˆ«æˆ¿é—´å¸ƒå±€
   - æå–æˆ·å‹ç‰¹ç‚¹

3. æ•ˆæœå›¾è§£æ
   - åœºæ™¯è¯†åˆ«ï¼ˆå®¢å…/å§å®¤/å¤–ç«‹é¢ç­‰ï¼‰
   - é£æ ¼è¯†åˆ«ï¼ˆç°ä»£/ä¸­å¼/æ¬§å¼ç­‰ï¼‰
   - ç”Ÿæˆæè¿°æ ‡ç­¾

4. åŒºä½å›¾è§£æ
   - OCRè¯†åˆ«åœ°æ ‡åç§°
   - è¯†åˆ«è·ç¦»ä¿¡æ¯
   - æå–é…å¥—åˆ—è¡¨
```

**æˆ·å‹å›¾è¾“å‡º**:
```json
{
  "image_type": "æˆ·å‹å›¾",
  "house_type": {
    "layout": "3å®¤2å…2å«",
    "area": "95ã¡",
    "orientation": "å—åŒ—",
    "rooms": [
      {"name": "ä¸»å§", "area": "15ã¡", "features": ["æœå—", "å¸¦é£˜çª—"]},
      {"name": "å®¢å…", "area": "28ã¡", "features": ["æœå—", "è¿æ¥é˜³å°"]}
    ],
    "highlights": ["å—åŒ—é€šé€", "åŠ¨é™åˆ†ç¦»", "å…¨æ˜æˆ·å‹"]
  }
}
```

#### 1.2.3 è§†é¢‘è§£æå™¨

**è¾“å…¥**: MP4/MOVè§†é¢‘ï¼ˆæ ·æ¿é—´è§†é¢‘ã€å®£ä¼ ç‰‡ç­‰ï¼‰

**å¤„ç†æµç¨‹**:
```
1. è§†é¢‘é¢„å¤„ç†
   - æå–éŸ³é¢‘è½¨é“
   - æŒ‰é—´éš”æå–å…³é”®å¸§ï¼ˆæ¯5ç§’ï¼‰

2. éŸ³é¢‘å¤„ç†
   - Whisperè¯­éŸ³è½¬æ–‡å­—
   - æå–è§£è¯´è¯å†…å®¹

3. å…³é”®å¸§åˆ†æ
   - åœºæ™¯è¯†åˆ«
   - æ–‡å­—OCR
   - ç”Ÿæˆå¸§æè¿°

4. å†…å®¹æ•´åˆ
   - æ—¶é—´è½´å¯¹é½
   - ç”Ÿæˆè§†é¢‘æ‘˜è¦
```

**è¾“å‡ºç»“æ„**:
```json
{
  "duration": "3:25",
  "transcript": "æ¬¢è¿æ¥åˆ°xxxèŠ±å›­æ ·æ¿é—´...",
  "scenes": [
    {"time": "0:00-0:30", "scene": "å¤–ç«‹é¢", "description": "ç°ä»£ç®€çº¦é£æ ¼å¤–ç«‹é¢"},
    {"time": "0:30-1:20", "scene": "å®¢å…", "description": "æŒ‘é«˜å®¢å…ï¼Œè½åœ°çª—è®¾è®¡"}
  ],
  "key_points": [
    "ç²¾è£…äº¤ä»˜",
    "270Â°ç¯å¹•å®¢å…",
    "ä¸»å§å¥—æˆ¿è®¾è®¡"
  ]
}
```

#### 1.2.4 è¡¨æ ¼è§£æå™¨

**è¾“å…¥**: Excel/CSV/å›¾ç‰‡è¡¨æ ¼ï¼ˆä»·æ ¼è¡¨ã€æˆ¿æºè¡¨ç­‰ï¼‰

**å¤„ç†æµç¨‹**:
```
1. æ ¼å¼å¤„ç†
   - Excel: xlsxåº“ç›´æ¥è§£æ
   - å›¾ç‰‡: OCR + è¡¨æ ¼ç»“æ„è¯†åˆ«

2. è¡¨æ ¼ç»“æ„åŒ–
   - è¯†åˆ«è¡¨å¤´
   - è§£ææ•°æ®è¡Œ
   - æ•°æ®ç±»å‹æ¨æ–­

3. è¯­ä¹‰ç†è§£
   - AIç†è§£è¡¨æ ¼å«ä¹‰
   - å­—æ®µæ˜ å°„åˆ°æ ‡å‡†ç»“æ„
```

**ä»·æ ¼è¡¨è¾“å‡º**:
```json
{
  "table_type": "ä»·æ ¼è¡¨",
  "update_date": "2026-02-01",
  "units": [
    {
      "building": "1æ ‹",
      "unit": "1å•å…ƒ",
      "floor": 15,
      "room": "1501",
      "house_type": "Aæˆ·å‹",
      "area": 95.5,
      "unit_price": 25000,
      "total_price": 2387500,
      "status": "åœ¨å”®"
    }
  ]
}
```

### 1.3 AIæå–Promptè®¾è®¡

#### æ¥¼ç›˜ä¿¡æ¯æå–Prompt

```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æˆ¿äº§ä¿¡æ¯æå–åŠ©æ‰‹ã€‚è¯·ä»ä»¥ä¸‹å†…å®¹ä¸­æå–æ¥¼ç›˜ä¿¡æ¯ï¼Œä»¥JSONæ ¼å¼è¿”å›ã€‚

éœ€è¦æå–çš„ä¿¡æ¯ï¼š
1. æ¥¼ç›˜åŸºç¡€ä¿¡æ¯ï¼ˆåç§°ã€å¼€å‘å•†ã€åœ°å€ã€ç‰©ä¸šç±»å‹ã€äº§æƒå¹´é™ã€äº¤æˆ¿æ—¶é—´ï¼‰
2. æˆ·å‹ä¿¡æ¯ï¼ˆæˆ·å‹åç§°ã€é¢ç§¯ã€æœå‘ã€ä»·æ ¼ã€ç‰¹ç‚¹ï¼‰
3. é…å¥—ä¿¡æ¯ï¼ˆäº¤é€šã€æ•™è‚²ã€å•†ä¸šã€åŒ»ç–—ã€ä¼‘é—²ï¼‰
4. æ ¸å¿ƒå–ç‚¹ï¼ˆ3-5ä¸ªæœ€çªå‡ºçš„å–ç‚¹ï¼‰

å¦‚æœæŸé¡¹ä¿¡æ¯æœªæåŠï¼Œè¿”å›nullã€‚

å†…å®¹ï¼š
{content}

è¯·è¿”å›JSONæ ¼å¼ï¼š
```

#### æˆ·å‹å›¾è§£æPrompt

```
è¯·åˆ†æè¿™å¼ æˆ·å‹å›¾ï¼Œæå–ä»¥ä¸‹ä¿¡æ¯ï¼š

1. æˆ·å‹å¸ƒå±€ï¼ˆå‡ å®¤å‡ å…å‡ å«ï¼‰
2. å»ºç­‘é¢ç§¯
3. æœå‘
4. å„æˆ¿é—´ä¿¡æ¯ï¼ˆåç§°ã€å¤§æ¦‚é¢ç§¯ã€ç‰¹ç‚¹ï¼‰
5. æˆ·å‹äº®ç‚¹ï¼ˆå¦‚å—åŒ—é€šé€ã€åŠ¨é™åˆ†ç¦»ç­‰ï¼‰

ä»¥JSONæ ¼å¼è¿”å›ç»“æœã€‚
```

---

## äºŒã€å†…å®¹ç”Ÿæˆç³»ç»Ÿ

### 2.1 ç”Ÿæˆæµç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·è¾“å…¥                                â”‚
â”‚  é€‰æ‹©æ¥¼ç›˜ â†’ é€‰æ‹©å†…å®¹ç±»å‹ â†’ é…ç½®å‚æ•°                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç‰©æ–™æ£€ç´¢                                  â”‚
â”‚  - åŠ è½½æ¥¼ç›˜åŸºç¡€ä¿¡æ¯                                         â”‚
â”‚  - æ£€ç´¢ç›¸å…³ç‰©æ–™                                             â”‚
â”‚  - æ„å»ºä¸Šä¸‹æ–‡                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Promptæ„å»º                                â”‚
â”‚  - é€‰æ‹©å¯¹åº”æ¨¡æ¿                                             â”‚
â”‚  - æ³¨å…¥æ¥¼ç›˜ä¿¡æ¯                                             â”‚
â”‚  - åº”ç”¨é£æ ¼å‚æ•°                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AIç”Ÿæˆ                                    â”‚
â”‚  - è°ƒç”¨Claude API                                           â”‚
â”‚  - æµå¼è¾“å‡º                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åå¤„ç†                                    â”‚
â”‚  - æ ¼å¼åŒ–è¾“å‡º                                               â”‚
â”‚  - æ•æ„Ÿè¯æ£€æŸ¥                                               â”‚
â”‚  - ä¿å­˜è®°å½•                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å†…å®¹æ¨¡æ¿è®¾è®¡

#### 2.2.1 å°çº¢ä¹¦æ¨æ–‡æ¨¡æ¿

**æ¨¡æ¿ç»“æ„**:
```yaml
template_id: xiaohongshu_tanpan
name: æ¢ç›˜ç¬”è®°
description: ä»¥ç¬¬ä¸€äººç§°æ¢ç›˜è§†è§’çš„ç§è‰ç¬”è®°

structure:
  title:
    format: "emoji + å¸ç›æ ‡é¢˜"
    max_length: 20
    examples:
      - "ğŸ å‘ç°å®è—æ¥¼ç›˜ï¼{area}åˆšéœ€ç¦éŸ³"
      - "ğŸ’°æ€»ä»·{price}ä¸‡ä¸Šè½¦{city}åœ°é“æˆ¿"

  body:
    sections:
      - name: å¼€åœº
        description: å¼•å…¥è¯é¢˜ï¼Œåˆ¶é€ å¥½å¥‡
        length: 50-100å­—

      - name: æ¥¼ç›˜ä»‹ç»
        description: ä½ç½®ã€å¼€å‘å•†ã€åŸºæœ¬ä¿¡æ¯
        length: 100-150å­—

      - name: æˆ·å‹åˆ†æ
        description: ä¸»æ¨æˆ·å‹è¯¦ç»†ä»‹ç»
        length: 150-200å­—

      - name: é…å¥—è¯´æ˜
        description: äº¤é€šã€å­¦æ ¡ã€å•†ä¸šç­‰
        length: 100-150å­—

      - name: ä»·æ ¼ä¿¡æ¯
        description: ä»·æ ¼åŒºé—´ã€æ€§ä»·æ¯”åˆ†æ
        length: 50-100å­—

      - name: æ€»ç»“å»ºè®®
        description: é€‚åˆäººç¾¤ã€è´­ä¹°å»ºè®®
        length: 50-100å­—

  tags:
    count: 5-10
    categories:
      - åŸå¸‚æ ‡ç­¾: "#ä¸Šæµ·ä¹°æˆ¿"
      - åŒºåŸŸæ ‡ç­¾: "#æµ¦ä¸œæ–°æˆ¿"
      - éœ€æ±‚æ ‡ç­¾: "#åˆšéœ€ä¸Šè½¦"
      - äº§å“æ ‡ç­¾: "#åœ°é“æˆ¿"
```

**ç”ŸæˆPrompt**:
```
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æˆ¿äº§åšä¸»ï¼Œæ“…é•¿å†™å°çº¢ä¹¦ç§è‰ç¬”è®°ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ¥¼ç›˜ä¿¡æ¯ï¼Œå†™ä¸€ç¯‡æ¢ç›˜ç¬”è®°ã€‚

## æ¥¼ç›˜ä¿¡æ¯
{project_info}

## å†™ä½œè¦æ±‚
1. æ ‡é¢˜è¦å¸ç›ï¼ŒåŒ…å«emojiï¼Œçªå‡ºæ ¸å¿ƒå–ç‚¹
2. æ­£æ–‡800-1200å­—ï¼Œåˆ†æ®µæ¸…æ™°
3. è¯­æ°”äº²åˆ‡è‡ªç„¶ï¼Œåƒæœ‹å‹åˆ†äº«
4. çªå‡ºä»¥ä¸‹å–ç‚¹ï¼š{highlights}
5. ç›®æ ‡è¯»è€…ï¼š{target_audience}
6. é£æ ¼ï¼š{style}

## è¾“å‡ºæ ¼å¼
æ ‡é¢˜ï¼šxxx
æ­£æ–‡ï¼šxxx
æ ‡ç­¾ï¼š#xxx #xxx

è¯·å¼€å§‹åˆ›ä½œï¼š
```

#### 2.2.2 çŸ­è§†é¢‘è„šæœ¬æ¨¡æ¿

**æ¨¡æ¿ç»“æ„**:
```yaml
template_id: video_script_30s
name: 30ç§’æ¥¼ç›˜ä»‹ç»
description: é€‚åˆæŠ–éŸ³/è§†é¢‘å·çš„çŸ­è§†é¢‘è„šæœ¬

structure:
  duration: 30s

  scenes:
    - name: å¼€åœºhook
      duration: 3-5s
      content: å¸å¼•æ³¨æ„åŠ›çš„å¼€åœºç™½
      visual: å¤–ç«‹é¢/èˆªæ‹

    - name: æ¥¼ç›˜å®šä½
      duration: 5-8s
      content: æ¥¼ç›˜åç§°ã€ä½ç½®ã€å¼€å‘å•†
      visual: åŒºä½å›¾/æ²™ç›˜

    - name: æ ¸å¿ƒå–ç‚¹
      duration: 10-12s
      content: 2-3ä¸ªæ ¸å¿ƒå–ç‚¹
      visual: é…å¥—å®æ™¯/æ•ˆæœå›¾

    - name: æˆ·å‹ä»·æ ¼
      duration: 5-8s
      content: ä¸»åŠ›æˆ·å‹å’Œä»·æ ¼
      visual: æˆ·å‹å›¾/æ ·æ¿é—´

    - name: ç»“å°¾å¼•å¯¼
      duration: 3-5s
      content: è¡ŒåŠ¨å·å¬
      visual: è”ç³»æ–¹å¼/äºŒç»´ç 

output_format:
  script: å®Œæ•´å£æ’­æ–‡æ¡ˆ
  subtitles: åˆ†æ®µå­—å¹•
  shot_list: åˆ†é•œå»ºè®®
  bgm_suggestion: èƒŒæ™¯éŸ³ä¹å»ºè®®
```

**ç”ŸæˆPrompt**:
```
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æˆ¿äº§çŸ­è§†é¢‘ç¼–å¯¼ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ¥¼ç›˜ä¿¡æ¯ï¼Œåˆ›ä½œä¸€ä¸ª{duration}ç§’çš„çŸ­è§†é¢‘è„šæœ¬ã€‚

## æ¥¼ç›˜ä¿¡æ¯
{project_info}

## è§†é¢‘è¦æ±‚
1. æ—¶é•¿ï¼š{duration}ç§’
2. å¹³å°ï¼š{platform}
3. é£æ ¼ï¼š{style}
4. çªå‡ºå–ç‚¹ï¼š{highlights}

## è¾“å‡ºæ ¼å¼

### å£æ’­æ–‡æ¡ˆ
ï¼ˆå®Œæ•´çš„å£æ’­ç¨¿ï¼Œæ ‡æ³¨æ—¶é—´èŠ‚ç‚¹ï¼‰

### åˆ†é•œè„šæœ¬
| æ—¶é—´ | ç”»é¢ | å£æ’­ | å­—å¹• |
|------|------|------|------|

### æ‹æ‘„å»ºè®®
- åœºæ™¯1ï¼šxxx
- åœºæ™¯2ï¼šxxx

### BGMå»ºè®®
é£æ ¼ï¼šxxx
å‚è€ƒæ›²ç›®ï¼šxxx

è¯·å¼€å§‹åˆ›ä½œï¼š
```

#### 2.2.3 æœ‹å‹åœˆæ–‡æ¡ˆæ¨¡æ¿

**æ¨¡æ¿ç»“æ„**:
```yaml
template_id: moments_recommend
name: æˆ¿æºæ¨è
description: æœ‹å‹åœˆæˆ¿æºæ¨èæ–‡æ¡ˆ

structure:
  text:
    max_length: 200
    format: |
      ã€æ¥¼ç›˜åç§°ã€‘ç®€çŸ­ä»‹ç»
      ğŸ“ä½ç½®ï¼šxxx
      ğŸ æˆ·å‹ï¼šxxx
      ğŸ’°ä»·æ ¼ï¼šxxx
      âœ¨äº®ç‚¹ï¼šxxx

  images:
    count: 6-9
    order:
      - æ•ˆæœå›¾ï¼ˆå°é¢ï¼‰
      - åŒºä½å›¾
      - æˆ·å‹å›¾x2
      - æ ·æ¿é—´x3
      - é…å¥—å®æ™¯
```

### 2.3 é£æ ¼å‚æ•°é…ç½®

```typescript
interface ContentStyle {
  // è¯­æ°”é£æ ¼
  tone: 'professional' | 'casual' | 'enthusiastic' | 'informative';

  // ç›®æ ‡å—ä¼—
  audience: 'first_time_buyer' | 'upgrader' | 'investor' | 'elderly';

  // å†…å®¹ä¾§é‡
  focus: 'price' | 'location' | 'quality' | 'education' | 'investment';

  // æ˜¯å¦åŒ…å«ä»·æ ¼
  includePrice: boolean;

  // emojiä½¿ç”¨ç¨‹åº¦
  emojiLevel: 'none' | 'minimal' | 'moderate' | 'heavy';

  // æ–‡æ¡ˆé•¿åº¦
  length: 'short' | 'medium' | 'long';
}
```

### 2.4 å†…å®¹è´¨é‡æ§åˆ¶

#### æ•æ„Ÿè¯è¿‡æ»¤
```typescript
const sensitiveWords = [
  // è¿è§„æ‰¿è¯º
  'ä¿å€¼', 'å¢å€¼', 'æŠ•èµ„å›æŠ¥', 'ç¨³èµš',
  // è™šå‡å®£ä¼ 
  'ç¬¬ä¸€', 'æœ€å¥½', 'ç»æ— ä»…æœ‰', 'ç‹¬ä¸€æ— äºŒ',
  // å…¶ä»–æ•æ„Ÿè¯
  'å­¦åŒºæˆ¿', 'åœ°é“æˆ¿'  // éœ€è¦æ ¸å®åä½¿ç”¨
];
```

#### å†…å®¹å®¡æ ¸æµç¨‹
```
ç”Ÿæˆå†…å®¹ â†’ æ•æ„Ÿè¯æ£€æŸ¥ â†’ äº‹å®æ ¸å¯¹ â†’ äººå·¥ç¡®è®¤ â†’ å‘å¸ƒ
```

---

## ä¸‰ã€æ•°æ®æµè®¾è®¡

### 3.1 ç‰©æ–™ä¸Šä¼ æ•°æ®æµ

```typescript
// ä¸Šä¼ è¯·æ±‚
interface UploadRequest {
  projectId: string;
  files: File[];
}

// è§£æä»»åŠ¡
interface ParseTask {
  id: string;
  fileId: string;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  progress: number;
  result?: ParseResult;
  error?: string;
}

// è§£æç»“æœ
interface ParseResult {
  fileType: string;
  category: string;
  extractedData: Record<string, any>;
  confidence: number;
}
```

### 3.2 å†…å®¹ç”Ÿæˆæ•°æ®æµ

```typescript
// ç”Ÿæˆè¯·æ±‚
interface GenerateRequest {
  projectId: string;
  contentType: 'xiaohongshu' | 'video_script' | 'moments';
  template?: string;
  style: ContentStyle;
  highlights?: string[];
}

// ç”Ÿæˆå“åº”ï¼ˆæµå¼ï¼‰
interface GenerateResponse {
  id: string;
  status: 'generating' | 'completed';
  content: string;  // å¢é‡å†…å®¹
  metadata?: {
    title?: string;
    tags?: string[];
    images?: string[];
  };
}
```

---

## å››ã€APIè®¾è®¡

### 4.1 ç‰©æ–™ç®¡ç†API

```typescript
// ä¸Šä¼ ç‰©æ–™
POST /api/projects/{projectId}/materials
Body: FormData (files)
Response: { taskIds: string[] }

// æŸ¥è¯¢è§£æçŠ¶æ€
GET /api/materials/tasks/{taskId}
Response: ParseTask

// è·å–ç‰©æ–™åˆ—è¡¨
GET /api/projects/{projectId}/materials
Query: { type?, category?, page?, limit? }
Response: { materials: Material[], total: number }

// æ›´æ–°ç‰©æ–™ä¿¡æ¯
PATCH /api/materials/{materialId}
Body: { category?, parsedContent? }

// åˆ é™¤ç‰©æ–™
DELETE /api/materials/{materialId}
```

### 4.2 å†…å®¹ç”ŸæˆAPI

```typescript
// ç”Ÿæˆå†…å®¹
POST /api/projects/{projectId}/generate
Body: GenerateRequest
Response: SSE stream of GenerateResponse

// è·å–ç”Ÿæˆå†å²
GET /api/projects/{projectId}/contents
Query: { type?, page?, limit? }
Response: { contents: GeneratedContent[], total: number }

// é‡æ–°ç”Ÿæˆ
POST /api/contents/{contentId}/regenerate
Body: { style?: ContentStyle }
Response: SSE stream of GenerateResponse
```

---

## äº”ã€æŠ€æœ¯å®ç°è¦ç‚¹

### 5.1 å¤§æ–‡ä»¶å¤„ç†

```typescript
// åˆ†ç‰‡ä¸Šä¼ 
const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB

async function uploadLargeFile(file: File, projectId: string) {
  const chunks = Math.ceil(file.size / CHUNK_SIZE);
  const uploadId = await initMultipartUpload(projectId, file.name);

  for (let i = 0; i < chunks; i++) {
    const chunk = file.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
    await uploadChunk(uploadId, i, chunk);
  }

  return await completeUpload(uploadId);
}
```

### 5.2 è§£æä»»åŠ¡é˜Ÿåˆ—

```typescript
// ä½¿ç”¨é˜Ÿåˆ—å¤„ç†è§£æä»»åŠ¡ï¼Œé¿å…é˜»å¡
class ParseQueue {
  private queue: ParseTask[] = [];
  private processing = false;

  async add(task: ParseTask) {
    this.queue.push(task);
    if (!this.processing) {
      this.process();
    }
  }

  private async process() {
    this.processing = true;
    while (this.queue.length > 0) {
      const task = this.queue.shift()!;
      await this.executeTask(task);
    }
    this.processing = false;
  }
}
```

### 5.3 æµå¼å†…å®¹ç”Ÿæˆ

```typescript
// ä½¿ç”¨SSEå®ç°æµå¼è¾“å‡º
async function* generateContent(request: GenerateRequest) {
  const context = await buildContext(request.projectId);
  const prompt = buildPrompt(request, context);

  const stream = await claude.messages.create({
    model: 'claude-sonnet-4-20250514',
    messages: [{ role: 'user', content: prompt }],
    stream: true
  });

  for await (const chunk of stream) {
    yield {
      status: 'generating',
      content: chunk.delta?.text || ''
    };
  }

  yield { status: 'completed', content: '' };
}
```

---

## å…­ã€å¤šæ¨¡å‹é€‚é…ç³»ç»Ÿ

å‚è€ƒ OpenClaw é¡¹ç›®çš„å¤šæ¨¡å‹æ¶æ„è®¾è®¡ï¼ŒYiYi æ”¯æŒå¤šç§ AI æ¨¡å‹æä¾›å•†ï¼Œå¹¶å…·å¤‡æ™ºèƒ½æ•…éšœè½¬ç§»èƒ½åŠ›ã€‚

### 6.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨å±‚                                  â”‚
â”‚         ç‰©æ–™è§£æ / å†…å®¹ç”Ÿæˆ / æ™ºèƒ½é—®ç­”                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ¨¡å‹è·¯ç”±å±‚                                 â”‚
â”‚  - æ¨¡å‹é€‰æ‹©                                                 â”‚
â”‚  - æ•…éšœè½¬ç§»                                                 â”‚
â”‚  - è´Ÿè½½å‡è¡¡                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Anthropic   â”‚  â”‚   OpenAI     â”‚  â”‚   å…¶ä»–æä¾›å•†  â”‚
â”‚  Claudeç³»åˆ—  â”‚  â”‚   GPTç³»åˆ—    â”‚  â”‚  Gemini/é€šä¹‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æ”¯æŒçš„æ¨¡å‹æä¾›å•†

| æä¾›å•† | æ¨¡å‹ | APIç±»å‹ | é€‚ç”¨åœºæ™¯ |
|--------|------|---------|----------|
| **Anthropic** | Claude 3.5/4 | anthropic-messages | ä¸»åŠ›æ¨¡å‹ï¼Œå†…å®¹ç”Ÿæˆ |
| **OpenAI** | GPT-4/4o | openai-completions | å¤‡ç”¨æ¨¡å‹ |
| **Google** | Gemini Pro | google-generative-ai | å¤šæ¨¡æ€è§£æ |
| **é˜¿é‡Œäº‘** | é€šä¹‰åƒé—® | openai-compatible | å›½å†…å¤‡ç”¨ |
| **æœ¬åœ°æ¨¡å‹** | Ollama/LMStudio | openai-compatible | ç¦»çº¿ä½¿ç”¨ |

### 6.3 é…ç½®ç»“æ„è®¾è®¡

#### æ¨¡å‹é…ç½®

```typescript
interface ModelConfig {
  // ä¸»æ¨¡å‹é…ç½®
  model: {
    primary: string;        // ä¸»æ¨¡å‹ "provider/model"
    fallbacks?: string[];   // æ•…éšœè½¬ç§»åˆ—è¡¨
  };

  // å›¾åƒå¤„ç†æ¨¡å‹ï¼ˆç”¨äºæˆ·å‹å›¾ã€æ•ˆæœå›¾è§£æï¼‰
  imageModel?: {
    primary: string;
    fallbacks?: string[];
  };

  // æ¨¡å‹ç›®å½•ï¼ˆå¯é…ç½®åˆ«åå’Œå‚æ•°ï¼‰
  models?: {
    [key: string]: {
      alias?: string;       // åˆ«åï¼Œå¦‚ "fast", "smart"
      params?: {            // æ¨¡å‹ç‰¹å®šå‚æ•°
        temperature?: number;
        maxTokens?: number;
      };
    };
  };
}
```

#### æä¾›å•†é…ç½®

```typescript
interface ProviderConfig {
  [providerId: string]: {
    baseUrl: string;                    // APIç«¯ç‚¹
    apiKey?: string;                    // APIå¯†é’¥
    auth: 'api-key' | 'oauth' | 'token'; // è®¤è¯æ–¹å¼
    api: ModelApi;                      // APIç±»å‹
    headers?: Record<string, string>;   // è‡ªå®šä¹‰è¯·æ±‚å¤´
    models: ModelDefinition[];          // æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨
  };
}

type ModelApi =
  | 'openai-completions'      // OpenAI å…¼å®¹
  | 'anthropic-messages'      // Anthropic åŸç”Ÿ
  | 'google-generative-ai';   // Google AI
```

#### é…ç½®æ–‡ä»¶ç¤ºä¾‹

```json5
// ~/.yiyi/config.json
{
  // æ¨¡å‹é…ç½®
  "model": {
    "primary": "anthropic/claude-sonnet-4-20250514",
    "fallbacks": [
      "openai/gpt-4o",
      "qwen/qwen-max"
    ]
  },

  // å›¾åƒæ¨¡å‹ï¼ˆå¤šæ¨¡æ€ï¼‰
  "imageModel": {
    "primary": "anthropic/claude-sonnet-4-20250514",
    "fallbacks": ["google/gemini-pro-vision"]
  },

  // æ¨¡å‹åˆ«å
  "models": {
    "anthropic/claude-sonnet-4-20250514": { "alias": "default" },
    "anthropic/claude-3-5-haiku-20241022": { "alias": "fast" },
    "anthropic/claude-opus-4-20250514": { "alias": "smart" }
  },

  // æä¾›å•†é…ç½®
  "providers": {
    "anthropic": {
      "apiKey": "${ANTHROPIC_API_KEY}"
    },
    "openai": {
      "apiKey": "${OPENAI_API_KEY}"
    },
    "qwen": {
      "baseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1",
      "apiKey": "${QWEN_API_KEY}",
      "api": "openai-completions"
    },
    "local": {
      "baseUrl": "http://localhost:11434/v1",
      "api": "openai-completions"
    }
  }
}
```

### 6.4 æ•…éšœè½¬ç§»æœºåˆ¶

#### æ•…éšœè½¬ç§»æµç¨‹

```typescript
interface FailoverAttempt {
  provider: string;
  model: string;
  error: Error;
  reason: FailoverReason;
  timestamp: number;
}

type FailoverReason =
  | 'auth'        // è®¤è¯å¤±è´¥
  | 'rate_limit'  // é€Ÿç‡é™åˆ¶
  | 'timeout'     // è¯·æ±‚è¶…æ—¶
  | 'billing'     // è®¡è´¹é—®é¢˜
  | 'unavailable' // æœåŠ¡ä¸å¯ç”¨
  | 'unknown';    // æœªçŸ¥é”™è¯¯

async function runWithFallback<T>(
  task: (provider: string, model: string) => Promise<T>,
  config: ModelConfig
): Promise<T> {
  const candidates = [
    config.model.primary,
    ...(config.model.fallbacks || [])
  ];

  const attempts: FailoverAttempt[] = [];

  for (const candidate of candidates) {
    const [provider, model] = parseModelRef(candidate);

    // æ£€æŸ¥å†·å´çŠ¶æ€
    if (isInCooldown(provider)) {
      attempts.push({ provider, model, reason: 'cooldown', ... });
      continue;
    }

    try {
      const result = await task(provider, model);
      // è®°å½•æˆåŠŸ
      recordSuccess(provider);
      return result;
    } catch (error) {
      const reason = classifyError(error);
      attempts.push({ provider, model, error, reason, ... });

      // æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦ç»§ç»­
      if (reason === 'auth' || reason === 'billing') {
        // è®¤è¯/è®¡è´¹é—®é¢˜ï¼Œè¿›å…¥å†·å´
        setCooldown(provider, 30 * 60 * 1000); // 30åˆ†é’Ÿ
      }

      // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæ¨¡å‹
      continue;
    }
  }

  // æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥
  throw new AllModelsFailedError(attempts);
}
```

#### å†·å´æœºåˆ¶

```typescript
interface CooldownState {
  provider: string;
  until: number;        // å†·å´ç»“æŸæ—¶é—´
  reason: FailoverReason;
  failCount: number;    // è¿ç»­å¤±è´¥æ¬¡æ•°
}

// å†·å´æ—¶é—´ç­–ç•¥ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
function getCooldownDuration(failCount: number): number {
  const base = 60 * 1000; // 1åˆ†é’Ÿ
  const max = 30 * 60 * 1000; // æœ€å¤§30åˆ†é’Ÿ
  return Math.min(base * Math.pow(2, failCount - 1), max);
}
```

### 6.5 è®¤è¯ç®¡ç†

#### æ”¯æŒçš„è®¤è¯æ–¹å¼

```typescript
// 1. API Key è®¤è¯ï¼ˆæœ€å¸¸ç”¨ï¼‰
interface ApiKeyAuth {
  type: 'api-key';
  key: string;
}

// 2. OAuth è®¤è¯ï¼ˆæ”¯æŒè‡ªåŠ¨åˆ·æ–°ï¼‰
interface OAuthAuth {
  type: 'oauth';
  accessToken: string;
  refreshToken: string;
  expiresAt: number;
  clientId?: string;
}

// 3. é™æ€ Token è®¤è¯
interface TokenAuth {
  type: 'token';
  token: string;
  expiresAt?: number;
}
```

#### è®¤è¯é…ç½®å­˜å‚¨

```typescript
// ~/.yiyi/auth.jsonï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
interface AuthStore {
  version: number;
  profiles: {
    [profileId: string]: {
      provider: string;
      credential: ApiKeyAuth | OAuthAuth | TokenAuth;
      email?: string;
      createdAt: number;
      lastUsed?: number;
    };
  };
  // æ¯ä¸ªæä¾›å•†çš„è®¤è¯é¡ºåº
  order?: {
    [provider: string]: string[];
  };
}
```

#### OAuth è‡ªåŠ¨åˆ·æ–°

```typescript
async function ensureValidToken(profile: OAuthProfile): Promise<string> {
  // æ£€æŸ¥æ˜¯å¦å³å°†è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
  if (profile.expiresAt - Date.now() < 5 * 60 * 1000) {
    const newTokens = await refreshOAuthToken(profile);
    await updateAuthStore(profile.id, newTokens);
    return newTokens.accessToken;
  }
  return profile.accessToken;
}
```

### 6.6 è¿è¡Œæ—¶æ¨¡å‹åˆ‡æ¢

#### æ¨¡å‹é€‰æ‹©å™¨

```typescript
interface ModelSelector {
  // è§£ææ¨¡å‹å¼•ç”¨
  parseRef(ref: string): { provider: string; model: string };

  // é€šè¿‡åˆ«åè·å–æ¨¡å‹
  getByAlias(alias: string): ModelRef | null;

  // è·å–æ¨èæ¨¡å‹ï¼ˆæ ¹æ®ä»»åŠ¡ç±»å‹ï¼‰
  getRecommended(task: TaskType): ModelRef;

  // åˆ—å‡ºå¯ç”¨æ¨¡å‹
  listAvailable(): ModelRef[];
}

type TaskType =
  | 'content_generation'  // å†…å®¹ç”Ÿæˆ - éœ€è¦åˆ›æ„
  | 'data_extraction'     // æ•°æ®æå– - éœ€è¦å‡†ç¡®
  | 'image_analysis'      // å›¾åƒåˆ†æ - éœ€è¦å¤šæ¨¡æ€
  | 'quick_query';        // å¿«é€ŸæŸ¥è¯¢ - éœ€è¦é€Ÿåº¦
```

#### ä»»åŠ¡çº§æ¨¡å‹é…ç½®

```typescript
// ä¸åŒä»»åŠ¡ä½¿ç”¨ä¸åŒæ¨¡å‹
const taskModelMapping = {
  // å†…å®¹ç”Ÿæˆï¼šä½¿ç”¨ä¸»åŠ›æ¨¡å‹
  content_generation: 'default',

  // æ•°æ®æå–ï¼šä½¿ç”¨å‡†ç¡®æ¨¡å‹
  data_extraction: 'smart',

  // å¿«é€ŸæŸ¥è¯¢ï¼šä½¿ç”¨å¿«é€Ÿæ¨¡å‹
  quick_query: 'fast',

  // å›¾åƒåˆ†æï¼šä½¿ç”¨å¤šæ¨¡æ€æ¨¡å‹
  image_analysis: 'imageModel'
};
```

### 6.7 æ¨¡å‹ç®¡ç† API

```typescript
// è·å–å½“å‰æ¨¡å‹é…ç½®
GET /api/models/config
Response: ModelConfig

// æ›´æ–°æ¨¡å‹é…ç½®
PATCH /api/models/config
Body: Partial<ModelConfig>

// åˆ—å‡ºå¯ç”¨æ¨¡å‹
GET /api/models/available
Response: { models: ModelInfo[] }

// æµ‹è¯•æ¨¡å‹è¿æ¥
POST /api/models/test
Body: { provider: string, model: string }
Response: { success: boolean, latency: number, error?: string }

// è·å–æ¨¡å‹ä½¿ç”¨ç»Ÿè®¡
GET /api/models/stats
Response: {
  usage: { [model: string]: { calls: number, tokens: number } },
  errors: { [model: string]: { count: number, lastError: string } }
}
```

### 6.8 æœ¬åœ°æ¨¡å‹æ”¯æŒ

æ”¯æŒé€šè¿‡ Ollama æˆ– LMStudio è¿è¡Œæœ¬åœ°æ¨¡å‹ï¼Œå®ç°ç¦»çº¿ä½¿ç”¨ã€‚

```typescript
// æœ¬åœ°æ¨¡å‹é…ç½®
const localProvider: ProviderConfig = {
  local: {
    baseUrl: 'http://localhost:11434/v1',  // Ollama é»˜è®¤ç«¯å£
    api: 'openai-completions',
    models: [
      { id: 'llama3.1:8b', name: 'Llama 3.1 8B' },
      { id: 'qwen2.5:7b', name: 'Qwen 2.5 7B' },
      { id: 'llava:13b', name: 'LLaVA 13B (å¤šæ¨¡æ€)' }
    ]
  }
};

// è‡ªåŠ¨æ£€æµ‹æœ¬åœ°æ¨¡å‹
async function discoverLocalModels(): Promise<ModelInfo[]> {
  try {
    const response = await fetch('http://localhost:11434/api/tags');
    const { models } = await response.json();
    return models.map(m => ({
      id: m.name,
      provider: 'local',
      size: m.size,
      modifiedAt: m.modified_at
    }));
  } catch {
    return []; // æœ¬åœ°æœåŠ¡æœªè¿è¡Œ
  }
}
```

---

## ä¸ƒã€AIè®²æˆ¿ç³»ç»Ÿ

### 7.1 3Så¿«é€Ÿè®²æˆ¿

#### ç”Ÿæˆé€»è¾‘

```typescript
interface ThreeSecondPitchRequest {
  projectId: string;
  emphasis: 'location' | 'price' | 'education' | 'quality' | 'layout';
  targetAudience: 'first_time' | 'upgrader' | 'investor';
  tone: 'professional' | 'friendly' | 'urgent';
  includePrice: boolean;
}

// ç”ŸæˆPromptæ¨¡æ¿
const pitchPrompt = `
ä½ æ˜¯ä¸€ä½èµ„æ·±æˆ¿äº§ç»çºªäººã€‚è¯·æ ¹æ®ä»¥ä¸‹æ¥¼ç›˜ä¿¡æ¯ï¼Œç”Ÿæˆä¸€å¥3ç§’å†…èƒ½è¯´å®Œçš„å¿«é€Ÿæ¨èè¯æœ¯ã€‚

## æ¥¼ç›˜ä¿¡æ¯
{project_info}

## è¦æ±‚
1. è¯æœ¯ç»“æ„ï¼š[æ¥¼ç›˜å®šä½] + [æ ¸å¿ƒå–ç‚¹] + [ä»·æ ¼/è¡ŒåŠ¨å¼•å¯¼]
2. çªå‡ºå–ç‚¹ï¼š{emphasis}
3. ç›®æ ‡å®¢ç¾¤ï¼š{targetAudience}
4. è¯­æ°”é£æ ¼ï¼š{tone}
5. å­—æ•°é™åˆ¶ï¼š30-50å­—
6. ${includePrice ? 'åŒ…å«å…·ä½“ä»·æ ¼' : 'ä¸åŒ…å«å…·ä½“ä»·æ ¼'}

## ç¤ºä¾‹
"XXèŠ±å›­ï¼Œåœ°é“å£300ç±³çº¯æ–°ç›˜ï¼Œ89å¹³ä¸‰æˆ¿æ€»ä»·280ä¸‡èµ·ï¼Œé¦–ä»˜50ä¸‡ä¸Šè½¦ï¼"

è¯·ç”Ÿæˆè¯æœ¯ï¼š
`;
```

### 7.2 AIè®²æˆ¿è¯æœ¯ç”Ÿæˆ

#### åœºæ™¯æ¨¡æ¿

```typescript
interface TourScriptRequest {
  projectId: string;
  scene: 'sandbox' | 'showroom' | 'garden' | 'surrounding';
  houseTypeId?: string;  // æ ·æ¿é—´è®²è§£éœ€è¦æŒ‡å®šæˆ·å‹
  duration: 'short' | 'standard' | 'detailed';
  includeQA: boolean;
}

// æ²™ç›˜è®²è§£æ¨¡æ¿
const sandboxTemplate = {
  sections: [
    { name: 'å¼€åœºç™½', duration: '30s', required: true },
    { name: 'åŒºä½ä»‹ç»', duration: '1-2min', required: true },
    { name: 'é¡¹ç›®è§„åˆ’', duration: '1-2min', required: true },
    { name: 'äº§å“ä»‹ç»', duration: '1min', required: true },
    { name: 'è¿‡æ¸¡å¼•å¯¼', duration: '15s', required: true }
  ]
};

// æ ·æ¿é—´è®²è§£æ¨¡æ¿
const showroomTemplate = {
  sections: [
    { name: 'å…¥æˆ·ç„å…³', duration: '30s', required: true },
    { name: 'å®¢é¤å…', duration: '1min', required: true },
    { name: 'ä¸»å§', duration: '1min', required: true },
    { name: 'æ¬¡å§/ä¹¦æˆ¿', duration: '30s', required: false },
    { name: 'å¨å«', duration: '30s', required: true },
    { name: 'é˜³å°', duration: '30s', required: false },
    { name: 'æ€»ç»“', duration: '30s', required: true }
  ]
};
```

#### å¼‚è®®å¤„ç†åº“

```typescript
interface ObjectionHandler {
  category: string;
  questions: {
    question: string;
    answer: string;
    tips: string[];
  }[];
}

const commonObjections: ObjectionHandler[] = [
  {
    category: 'ä»·æ ¼å¼‚è®®',
    questions: [
      {
        question: 'ä»·æ ¼å¤ªè´µäº†',
        answer: 'æ‚¨è¯´çš„å¯¹ï¼Œè¿™ä¸ªä»·æ ¼ç¡®å®ä¸ä½ã€‚ä½†æ‚¨çœ‹...',
        tips: ['å¼ºè°ƒæ€§ä»·æ¯”', 'å¯¹æ¯”å‘¨è¾¹', 'åˆ†æå‡å€¼ç©ºé—´']
      }
    ]
  },
  {
    category: 'æˆ·å‹å¼‚è®®',
    questions: [
      {
        question: 'è¿™ä¸ªæˆ·å‹æœ‰ç‚¹å°',
        answer: 'é¢ç§¯ç¡®å®ç´§å‡‘ï¼Œä½†ç©ºé—´åˆ©ç”¨ç‡å¾ˆé«˜...',
        tips: ['å¼ºè°ƒå¾—æˆ¿ç‡', 'å±•ç¤ºæ”¶çº³è®¾è®¡', 'å¯¹æ¯”åŒé¢ç§¯æˆ·å‹']
      }
    ]
  }
];
```

### 7.3 VRè®²æˆ¿

#### VRåœºæ™¯è¯†åˆ«

```typescript
interface VRSceneAnalysis {
  sceneType: 'living_room' | 'bedroom' | 'kitchen' | 'bathroom' | 'balcony';
  features: string[];
  suggestedScript: string;
}

// ä½¿ç”¨å¤šæ¨¡æ€æ¨¡å‹åˆ†æVRæˆªå›¾
async function analyzeVRScene(imageUrl: string): Promise<VRSceneAnalysis> {
  const response = await claude.messages.create({
    model: 'claude-sonnet-4-20250514',
    messages: [{
      role: 'user',
      content: [
        { type: 'image', source: { type: 'url', url: imageUrl } },
        { type: 'text', text: 'åˆ†æè¿™ä¸ªVRçœ‹æˆ¿åœºæ™¯ï¼Œè¯†åˆ«æˆ¿é—´ç±»å‹å’Œç‰¹ç‚¹ï¼Œç”Ÿæˆè®²è§£è¯' }
      ]
    }]
  });
  return parseVRAnalysis(response);
}
```

#### è¯­éŸ³åˆæˆé›†æˆ

```typescript
interface TTSConfig {
  provider: 'azure' | 'aliyun' | 'local';
  voice: string;
  speed: number;
  pitch: number;
}

async function generateVoiceNarration(
  script: string,
  config: TTSConfig
): Promise<string> {
  // è¿”å›éŸ³é¢‘æ–‡ä»¶URL
  const audioUrl = await ttsService.synthesize(script, config);
  return audioUrl;
}
```

---

## å…«ã€PPTç”Ÿæˆç³»ç»Ÿ

### 8.1 PPTç”Ÿæˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PPTç”Ÿæˆè¯·æ±‚                             â”‚
â”‚         æ¥¼ç›˜ID / æ¨¡æ¿ç±»å‹ / è‡ªå®šä¹‰é€‰é¡¹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å‡†å¤‡                                â”‚
â”‚  - æ¥¼ç›˜åŸºç¡€ä¿¡æ¯                                             â”‚
â”‚  - æˆ·å‹æ•°æ®                                                 â”‚
â”‚  - ç‰©æ–™èµ„æºï¼ˆå›¾ç‰‡ã€å›¾è¡¨ï¼‰                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å†…å®¹ç”Ÿæˆ                                â”‚
â”‚  - AIç”Ÿæˆæ–‡æ¡ˆ                                               â”‚
â”‚  - æ•°æ®å¯è§†åŒ–                                               â”‚
â”‚  - å¸ƒå±€è§„åˆ’                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PPTæ¸²æŸ“                                 â”‚
â”‚  - æ¨¡æ¿åº”ç”¨                                                 â”‚
â”‚  - å›¾ç‰‡æ’å…¥                                                 â”‚
â”‚  - æ ·å¼è°ƒæ•´                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è¾“å‡º                                    â”‚
â”‚         PPTX / PDF / å›¾ç‰‡åºåˆ—                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 PPTæ¨¡æ¿ç³»ç»Ÿ

```typescript
interface PPTTemplate {
  id: string;
  name: string;
  description: string;
  pageCount: { min: number; max: number };
  style: 'simple' | 'business' | 'modern' | 'luxury';
  colorScheme: {
    primary: string;
    secondary: string;
    accent: string;
    background: string;
  };
  pages: PPTPageTemplate[];
}

interface PPTPageTemplate {
  type: 'cover' | 'content' | 'image' | 'comparison' | 'contact';
  layout: string;
  placeholders: {
    id: string;
    type: 'text' | 'image' | 'chart' | 'table';
    position: { x: number; y: number; width: number; height: number };
    style?: Record<string, any>;
  }[];
}
```

### 8.3 PPTç”ŸæˆAPI

```typescript
// ç”ŸæˆPPT
POST /api/projects/{projectId}/ppt
Body: {
  templateId: string;
  options: {
    includePages: string[];      // åŒ…å«çš„é¡µé¢ç±»å‹
    houseTypes: string[];        // å±•ç¤ºçš„æˆ·å‹
    includePrice: boolean;
    agentInfo?: {
      name: string;
      phone: string;
      qrCode?: string;
    };
  };
}
Response: {
  taskId: string;
  status: 'processing';
}

// æŸ¥è¯¢ç”ŸæˆçŠ¶æ€
GET /api/ppt/tasks/{taskId}
Response: {
  status: 'processing' | 'completed' | 'failed';
  progress: number;
  result?: {
    pptxUrl: string;
    pdfUrl: string;
    previewImages: string[];
  };
}
```

### 8.4 æŠ€æœ¯å®ç°

```typescript
// ä½¿ç”¨ pptxgenjs ç”ŸæˆPPT
import PptxGenJS from 'pptxgenjs';

async function generatePPT(
  project: Project,
  template: PPTTemplate,
  options: PPTOptions
): Promise<Buffer> {
  const pptx = new PptxGenJS();

  // è®¾ç½®ä¸»é¢˜
  pptx.defineLayout({ name: 'LAYOUT_16x9', width: 10, height: 5.625 });
  pptx.layout = 'LAYOUT_16x9';

  // ç”Ÿæˆå°é¢
  const coverSlide = pptx.addSlide();
  await renderCoverPage(coverSlide, project, template);

  // ç”Ÿæˆå†…å®¹é¡µ
  for (const pageType of options.includePages) {
    const slide = pptx.addSlide();
    await renderContentPage(slide, project, pageType, template);
  }

  // ç”Ÿæˆæˆ·å‹é¡µ
  for (const houseTypeId of options.houseTypes) {
    const houseType = project.houseTypes.find(h => h.id === houseTypeId);
    if (houseType) {
      const slide = pptx.addSlide();
      await renderHouseTypePage(slide, houseType, template);
    }
  }

  // ç”Ÿæˆè”ç³»é¡µ
  if (options.agentInfo) {
    const contactSlide = pptx.addSlide();
    await renderContactPage(contactSlide, options.agentInfo, template);
  }

  return await pptx.write({ outputType: 'nodebuffer' });
}
```

---

## ä¹ã€IPå½¢è±¡ç³»ç»Ÿ

### 9.1 IPæ•°æ®ç»“æ„

```typescript
interface AgentProfile {
  id: string;
  userId: string;

  // åŸºç¡€ä¿¡æ¯
  name: string;
  nickname?: string;
  avatar: string;
  coverImage?: string;

  // ä¸“ä¸šä¿¡æ¯
  yearsOfExperience: number;
  specializedAreas: string[];      // æ“…é•¿åŒºåŸŸ
  specializedTypes: string[];      // æ“…é•¿æˆ·å‹
  totalDeals: number;              // æˆäº¤å¥—æ•°
  totalClients: number;            // æœåŠ¡å®¢æˆ·æ•°

  // IPé£æ ¼
  style: 'professional' | 'friendly' | 'expert' | 'energetic';
  slogan: string;
  introduction: string;

  // ç»Ÿä¸€å…ƒç´ 
  signature: string;               // ç­¾åæ¡£
  openingLine: string;             // å¼€åœºç™½
  closingLine: string;             // ç»“æŸè¯­
  watermark: WatermarkConfig;

  // è”ç³»æ–¹å¼
  phone: string;
  wechat?: string;
  qrCode?: string;

  createdAt: Date;
  updatedAt: Date;
}

interface WatermarkConfig {
  enabled: boolean;
  position: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right';
  opacity: number;
  includeAvatar: boolean;
  includeName: boolean;
  includePhone: boolean;
}
```

### 9.2 å†…å®¹é£æ ¼ç»Ÿä¸€

```typescript
// è‡ªåŠ¨æ·»åŠ ç­¾å
function applySignature(content: string, profile: AgentProfile): string {
  return `${content}\n\n${profile.signature}`;
}

// ç”Ÿæˆå¸¦æ°´å°çš„å›¾ç‰‡
async function addWatermark(
  imageBuffer: Buffer,
  profile: AgentProfile
): Promise<Buffer> {
  const { watermark } = profile;
  if (!watermark.enabled) return imageBuffer;

  // ä½¿ç”¨ sharp æ·»åŠ æ°´å°
  const watermarkImage = await generateWatermarkImage(profile, watermark);
  return await sharp(imageBuffer)
    .composite([{
      input: watermarkImage,
      gravity: watermark.position.replace('-', '')
    }])
    .toBuffer();
}
```

### 9.3 æˆäº¤æµ·æŠ¥ç”Ÿæˆ

```typescript
interface PosterRequest {
  type: 'deal' | 'monthly' | 'testimonial';
  data: DealPosterData | MonthlyPosterData | TestimonialPosterData;
  templateId?: string;
}

interface DealPosterData {
  clientName: string;
  projectName: string;
  houseType: string;
  dealDate: Date;
  agentProfile: AgentProfile;
}

// ä½¿ç”¨ canvas ç”Ÿæˆæµ·æŠ¥
async function generatePoster(request: PosterRequest): Promise<Buffer> {
  const canvas = createCanvas(1080, 1920);
  const ctx = canvas.getContext('2d');

  // åŠ è½½æ¨¡æ¿èƒŒæ™¯
  const template = await loadTemplate(request.templateId);
  ctx.drawImage(template.background, 0, 0);

  // æ¸²æŸ“å†…å®¹
  switch (request.type) {
    case 'deal':
      await renderDealPoster(ctx, request.data as DealPosterData);
      break;
    case 'monthly':
      await renderMonthlyPoster(ctx, request.data as MonthlyPosterData);
      break;
    case 'testimonial':
      await renderTestimonialPoster(ctx, request.data as TestimonialPosterData);
      break;
  }

  return canvas.toBuffer('image/png');
}
```

### 9.4 APIæ¥å£

```typescript
// è·å–ç»çºªäººIPä¿¡æ¯
GET /api/agent-profile
Response: AgentProfile

// æ›´æ–°ç»çºªäººIPä¿¡æ¯
PUT /api/agent-profile
Body: Partial<AgentProfile>

// ç”Ÿæˆæµ·æŠ¥
POST /api/posters
Body: PosterRequest
Response: { taskId: string; status: 'processing' }

// è·å–æµ·æŠ¥ç”Ÿæˆç»“æœ
GET /api/posters/{taskId}
Response: { status: string; imageUrl?: string }

// æ·»åŠ æ°´å°
POST /api/watermark
Body: { imageUrl: string }
Response: { imageUrl: string }
```

---

## åã€å®¢æˆ·ç®¡ç†ç³»ç»Ÿ

### 10.1 æ•°æ®ç»“æ„

```typescript
interface Customer {
  id: string;
  agentId: string;              // æ‰€å±ç»çºªäºº

  // åŸºæœ¬ä¿¡æ¯
  name: string;                 // ç§°å‘¼
  phone?: string;
  wechat?: string;

  // éœ€æ±‚ä¿¡æ¯
  budget: { min: number; max: number };  // é¢„ç®—èŒƒå›´ï¼ˆä¸‡ï¼‰
  areas: string[];              // æ„å‘åŒºåŸŸ
  houseType: string;            // æˆ·å‹éœ€æ±‚
  purpose: 'self' | 'invest' | 'education' | 'retirement';

  // æ ‡ç­¾
  autoTags: string[];           // ç³»ç»Ÿè‡ªåŠ¨æ ‡ç­¾
  manualTags: string[];         // æ‰‹åŠ¨æ ‡ç­¾

  // çŠ¶æ€
  status: 'new' | 'contacted' | 'toured' | 'negotiating' | 'closed' | 'paused';
  lastContactAt: Date;
  nextFollowUpAt?: Date;

  // è®°å½•
  notes: string;
  createdAt: Date;
  updatedAt: Date;
}

interface FollowUpRecord {
  id: string;
  customerId: string;
  type: 'call' | 'wechat' | 'tour' | 'meeting' | 'other';
  content: string;
  result?: string;
  nextAction?: string;
  createdAt: Date;
}
```

### 10.2 æ™ºèƒ½æ ‡ç­¾å¼•æ“

```typescript
// æ ¹æ®å®¢æˆ·ä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾
function generateAutoTags(customer: Customer): string[] {
  const tags: string[] = [];

  // é¢„ç®—æ ‡ç­¾
  if (customer.budget.max <= 200) tags.push('åˆšéœ€');
  else if (customer.budget.max <= 500) tags.push('æ”¹å–„');
  else tags.push('é«˜ç«¯');

  // åŒºåŸŸæ ‡ç­¾
  customer.areas.forEach(area => {
    tags.push(`${area}å®¢`);
  });

  // ç›®çš„æ ‡ç­¾
  const purposeMap = {
    self: 'è‡ªä½', invest: 'æŠ•èµ„',
    education: 'å­¦åŒº', retirement: 'å…»è€'
  };
  tags.push(purposeMap[customer.purpose]);

  return tags;
}
```

### 10.3 è·Ÿè¿›æé†’è°ƒåº¦

```typescript
interface FollowUpRule {
  status: Customer['status'];
  idleDays: number;             // æœªè·Ÿè¿›å¤©æ•°é˜ˆå€¼
  reminderTemplate: string;     // æé†’è¯æœ¯æ¨¡æ¿
  priority: 'high' | 'medium' | 'low';
}

const followUpRules: FollowUpRule[] = [
  { status: 'new', idleDays: 1, reminderTemplate: '{name}è¿˜æ²¡è·Ÿè¿›ï¼Œå‘æ¡æ¶ˆæ¯é—®é—®éœ€æ±‚ï¼Ÿ', priority: 'high' },
  { status: 'contacted', idleDays: 3, reminderTemplate: '{name}{days}å¤©æ²¡è”ç³»äº†ï¼Œçº¦ä¸ªæ—¶é—´å¸¦çœ‹ï¼Ÿ', priority: 'medium' },
  { status: 'toured', idleDays: 2, reminderTemplate: '{name}çœ‹æˆ¿å{days}å¤©äº†ï¼Œé—®é—®è€ƒè™‘å¾—æ€ä¹ˆæ ·ï¼Ÿ', priority: 'high' },
  { status: 'negotiating', idleDays: 1, reminderTemplate: '{name}åœ¨è€ƒè™‘ä¸­ï¼Œä»Šå¤©è·Ÿè¿›ä¸€ä¸‹ï¼Ÿ', priority: 'high' },
  { status: 'paused', idleDays: 7, reminderTemplate: '{name}æç½®ä¸€å‘¨äº†ï¼Œè¦ä¸è¦æ¿€æ´»ï¼Ÿ', priority: 'low' },
];

// æ¯æ—¥å®šæ—¶ä»»åŠ¡ï¼šæ‰«æéœ€è¦è·Ÿè¿›çš„å®¢æˆ·
async function scanFollowUps(agentId: string): Promise<FollowUpReminder[]> {
  const customers = await db.customers.findMany({
    where: { agentId, status: { not: 'closed' } }
  });

  const reminders: FollowUpReminder[] = [];
  const now = new Date();

  for (const customer of customers) {
    const rule = followUpRules.find(r => r.status === customer.status);
    if (!rule) continue;

    const idleDays = diffDays(now, customer.lastContactAt);
    if (idleDays >= rule.idleDays) {
      reminders.push({
        customerId: customer.id,
        customerName: customer.name,
        message: rule.reminderTemplate
          .replace('{name}', customer.name)
          .replace('{days}', String(idleDays)),
        priority: rule.priority,
      });
    }
  }

  return reminders.sort((a, b) =>
    priorityOrder[a.priority] - priorityOrder[b.priority]
  );
}
```

### 10.4 APIæ¥å£

```typescript
// åˆ›å»ºå®¢æˆ·ï¼ˆæ”¯æŒè‡ªç„¶è¯­è¨€å½•å…¥ï¼‰
POST /api/customers
Body: {
  mode: 'form' | 'natural_language';
  data?: Partial<Customer>;       // formæ¨¡å¼
  text?: string;                  // è‡ªç„¶è¯­è¨€æ¨¡å¼
}

// å®¢æˆ·åˆ—è¡¨
GET /api/customers?status=new&tag=åˆšéœ€&page=1&limit=20

// æ›´æ–°å®¢æˆ·çŠ¶æ€
PATCH /api/customers/{id}
Body: Partial<Customer>

// æ·»åŠ è·Ÿè¿›è®°å½•
POST /api/customers/{id}/follow-ups
Body: { type: string; content: string; nextAction?: string }

// è·å–ä»Šæ—¥å¾…è·Ÿè¿›
GET /api/follow-up-reminders

// AIè§£æè‡ªç„¶è¯­è¨€å½•å…¥
POST /api/customers/parse
Body: { text: string }
Response: Partial<Customer>
```

---

## åä¸€ã€æ¥¼ç›˜ä¿¡æ¯æŸ¥è¯¢ç³»ç»Ÿ

### 11.1 æŸ¥è¯¢æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·è‡ªç„¶è¯­è¨€è¾“å…¥                          â”‚
â”‚         "XXèŠ±å›­89å¹³çš„æˆ·å‹æ€ä¹ˆæ ·"                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ„å›¾è¯†åˆ« (NLU)                           â”‚
â”‚  - æŸ¥è¯¢ç±»å‹åˆ†ç±»                                              â”‚
â”‚  - å®ä½“æå–ï¼ˆæ¥¼ç›˜åã€æˆ·å‹ã€é¢ç§¯ç­‰ï¼‰                            â”‚
â”‚  - å‚æ•°æ ‡å‡†åŒ–                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æŸ¥è¯¢è·¯ç”±                                 â”‚
â”‚  åŸºç¡€ä¿¡æ¯ â”‚ æˆ·å‹æŸ¥è¯¢ â”‚ ä»·æ ¼æŸ¥è¯¢ â”‚ é…å¥—æŸ¥è¯¢ â”‚ å¯¹æ¯”æŸ¥è¯¢          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®æ£€ç´¢ + AIæ ¼å¼åŒ–                      â”‚
â”‚  - ä»ç‰©æ–™åº“æ£€ç´¢ç»“æ„åŒ–æ•°æ®                                     â”‚
â”‚  - AIç”Ÿæˆè‡ªç„¶è¯­è¨€å›ç­”                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 æ„å›¾è¯†åˆ«

```typescript
type QueryIntent =
  | 'basic_info'      // åŸºç¡€ä¿¡æ¯ï¼ˆä½ç½®ã€å¼€å‘å•†ã€äº¤æˆ¿æ—¶é—´ï¼‰
  | 'house_type'      // æˆ·å‹æŸ¥è¯¢
  | 'price'           // ä»·æ ¼æŸ¥è¯¢
  | 'facilities'      // é…å¥—æŸ¥è¯¢
  | 'comparison'      // æ¥¼ç›˜å¯¹æ¯”
  | 'unknown';

interface QueryParseResult {
  intent: QueryIntent;
  entities: {
    projectNames: string[];     // æ¥¼ç›˜åç§°
    houseType?: string;         // æˆ·å‹
    area?: number;              // é¢ç§¯
    facilityType?: string;      // é…å¥—ç±»å‹ï¼ˆå­¦æ ¡/åœ°é“/å•†åœºï¼‰
  };
  confidence: number;
}

const intentClassifyPrompt = `
ä½ æ˜¯ä¸€ä¸ªæˆ¿äº§æŸ¥è¯¢æ„å›¾åˆ†ç±»å™¨ã€‚æ ¹æ®ç”¨æˆ·è¾“å…¥ï¼Œè¿”å›JSONï¼š
{
  "intent": "basic_info|house_type|price|facilities|comparison",
  "entities": {
    "projectNames": ["æ¥¼ç›˜å"],
    "houseType": "æˆ·å‹ï¼ˆå¯é€‰ï¼‰",
    "area": é¢ç§¯æ•°å­—ï¼ˆå¯é€‰ï¼‰,
    "facilityType": "é…å¥—ç±»å‹ï¼ˆå¯é€‰ï¼‰"
  }
}

ç”¨æˆ·è¾“å…¥ï¼š{query}
`;
```

### 11.3 æ•°æ®æ£€ç´¢

```typescript
async function queryProjectInfo(
  parsed: QueryParseResult
): Promise<QueryResponse> {
  const project = await db.projects.findFirst({
    where: { name: { contains: parsed.entities.projectNames[0] } },
    include: { houseTypes: true, facilities: true, materials: true }
  });

  if (!project) {
    return { type: 'not_found', suggestion: 'è¦å¸®ä½ æ·»åŠ è¿™ä¸ªæ¥¼ç›˜å—ï¼Ÿ' };
  }

  switch (parsed.intent) {
    case 'basic_info':
      return formatBasicInfo(project);
    case 'house_type':
      return formatHouseType(project, parsed.entities.area);
    case 'price':
      return formatPrice(project, parsed.entities.houseType);
    case 'facilities':
      return formatFacilities(project, parsed.entities.facilityType);
    case 'comparison':
      const project2 = await db.projects.findFirst({
        where: { name: { contains: parsed.entities.projectNames[1] } },
        include: { houseTypes: true, facilities: true }
      });
      return formatComparison(project, project2);
    default:
      return { type: 'clarify', suggestion: 'ä½ æƒ³äº†è§£å“ªæ–¹é¢ä¿¡æ¯ï¼Ÿ' };
  }
}
```

### 11.4 å¯¹æ¯”è¡¨æ ¼ç”Ÿæˆ

```typescript
interface ComparisonTable {
  dimensions: string[];
  projects: {
    name: string;
    values: Record<string, string>;
  }[];
  summary: string;
}

function generateComparison(
  projectA: Project,
  projectB: Project
): ComparisonTable {
  const dimensions = [
    'ä½ç½®', 'å¼€å‘å•†', 'ä¸»åŠ›æˆ·å‹', 'å•ä»·', 'åœ°é“', 'å­¦åŒº', 'äº¤æˆ¿æ—¶é—´'
  ];

  return {
    dimensions,
    projects: [
      { name: projectA.name, values: extractValues(projectA, dimensions) },
      { name: projectB.name, values: extractValues(projectB, dimensions) },
    ],
    summary: '' // ç”±AIç”Ÿæˆæ€»ç»“å»ºè®®
  };
}
```

### 11.5 APIæ¥å£

```typescript
// è‡ªç„¶è¯­è¨€æŸ¥è¯¢
POST /api/query
Body: { question: string; context?: string }
Response: {
  intent: QueryIntent;
  answer: string;
  data?: any;              // ç»“æ„åŒ–æ•°æ®
  suggestions?: string[];  // è¿½é—®å»ºè®®
}

// æ¥¼ç›˜å¯¹æ¯”
POST /api/projects/compare
Body: { projectIds: string[] }
Response: ComparisonTable
```

---

## åäºŒã€æ™ºèƒ½åŒ¹é…å¼•æ“

### 12.1 åŒ¹é…æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·éœ€æ±‚    â”‚    â”‚   æ¥¼ç›˜ç‰¹å¾    â”‚
â”‚  ç»“æ„åŒ–æ•°æ®   â”‚    â”‚  ç»“æ„åŒ–æ•°æ®   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚
       â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éœ€æ±‚å‘é‡åŒ–   â”‚    â”‚  æ¥¼ç›˜å‘é‡åŒ–   â”‚
â”‚  Embedding   â”‚    â”‚  Embedding   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   å¤šç»´åº¦åŒ¹é…    â”‚
       â”‚  åŠ æƒç›¸ä¼¼åº¦è®¡ç®—  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   æ’åº + AIè§£é‡Š â”‚
       â”‚  ç”Ÿæˆæ¨èç†ç”±   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.2 å‘é‡åŒ–ä¸ç´¢å¼•

```typescript
// ä½¿ç”¨å‘é‡æ•°æ®åº“å­˜å‚¨æ¥¼ç›˜ç‰¹å¾
import { ChromaClient } from 'chromadb';

const chroma = new ChromaClient();
const projectCollection = await chroma.getOrCreateCollection({
  name: 'project_vectors',
  metadata: { 'hnsw:space': 'cosine' }
});

// æ¥¼ç›˜ç‰¹å¾å‘é‡åŒ–
async function indexProject(project: Project): Promise<void> {
  const featureText = [
    `åŒºåŸŸ:${project.district}`,
    `å•ä»·:${project.unitPrice}ä¸‡`,
    `é¢ç§¯:${project.houseTypes.map(h => h.area).join('/')}ã¡`,
    `é…å¥—:${project.facilities.map(f => f.name).join(',')}`,
    `äº§å“:${project.productType}`,
    `äº¤æˆ¿:${project.deliveryDate}`,
  ].join(' ');

  await projectCollection.upsert({
    ids: [project.id],
    documents: [featureText],
    metadatas: [{
      district: project.district,
      minPrice: project.minTotalPrice,
      maxPrice: project.maxTotalPrice,
      minArea: Math.min(...project.houseTypes.map(h => h.area)),
      maxArea: Math.max(...project.houseTypes.map(h => h.area)),
    }]
  });
}
```

### 12.3 å¤šç»´åº¦åŒ¹é…ç®—æ³•

```typescript
interface MatchDimension {
  name: string;
  weight: number;
  scorer: (customer: Customer, project: Project) => number;
}

const matchDimensions: MatchDimension[] = [
  {
    name: 'ä»·æ ¼åŒ¹é…',
    weight: 0.3,
    scorer: (c, p) => {
      const budgetCenter = (c.budget.min + c.budget.max) / 2;
      const priceCenter = (p.minTotalPrice + p.maxTotalPrice) / 2;
      const diff = Math.abs(budgetCenter - priceCenter) / budgetCenter;
      return Math.max(0, 1 - diff);
    }
  },
  {
    name: 'åŒºåŸŸåŒ¹é…',
    weight: 0.25,
    scorer: (c, p) => c.areas.includes(p.district) ? 1.0 : 0.0
  },
  {
    name: 'é¢ç§¯åŒ¹é…',
    weight: 0.2,
    scorer: (c, p) => {
      const hasMatch = p.houseTypes.some(h =>
        h.rooms === parseInt(c.houseType) ||
        (h.area >= c.budget.min * 0.8 && h.area <= c.budget.max * 1.2)
      );
      return hasMatch ? 1.0 : 0.3;
    }
  },
  {
    name: 'é…å¥—åŒ¹é…',
    weight: 0.15,
    scorer: (c, p) => {
      const needs = extractFacilityNeeds(c);
      const has = p.facilities.map(f => f.type);
      const matched = needs.filter(n => has.includes(n)).length;
      return needs.length > 0 ? matched / needs.length : 0.5;
    }
  },
  {
    name: 'äº§å“åŒ¹é…',
    weight: 0.1,
    scorer: (c, p) => {
      const pref = extractProductPreference(c);
      return pref === p.productType ? 1.0 : 0.5;
    }
  }
];

async function matchProjects(
  customer: Customer,
  limit: number = 5
): Promise<MatchResult[]> {
  // ç¬¬ä¸€æ­¥ï¼šå‘é‡ç²—ç­›ï¼ˆå¬å›Top 20ï¼‰
  const candidates = await projectCollection.query({
    queryTexts: [buildCustomerQuery(customer)],
    nResults: 20,
    where: {
      minPrice: { $lte: customer.budget.max * 10000 },
      maxPrice: { $gte: customer.budget.min * 10000 },
    }
  });

  // ç¬¬äºŒæ­¥ï¼šå¤šç»´åº¦ç²¾æ’
  const projects = await db.projects.findMany({
    where: { id: { in: candidates.ids[0] } },
    include: { houseTypes: true, facilities: true }
  });

  const scored = projects.map(project => {
    const scores = matchDimensions.map(dim => ({
      dimension: dim.name,
      score: dim.scorer(customer, project),
      weight: dim.weight,
    }));
    const totalScore = scores.reduce((sum, s) => sum + s.score * s.weight, 0);
    return { project, scores, totalScore };
  });

  // ç¬¬ä¸‰æ­¥ï¼šæ’åºå–Top N
  scored.sort((a, b) => b.totalScore - a.totalScore);
  const topResults = scored.slice(0, limit);

  // ç¬¬å››æ­¥ï¼šAIç”Ÿæˆæ¨èç†ç”±
  for (const result of topResults) {
    result.reason = await generateMatchReason(customer, result);
  }

  return topResults;
}
```

### 12.4 æ¨èç†ç”±ç”Ÿæˆ

```typescript
const matchReasonPrompt = `
æ ¹æ®å®¢æˆ·éœ€æ±‚å’Œæ¥¼ç›˜ä¿¡æ¯ï¼Œç”Ÿæˆç®€æ´çš„æ¨èç†ç”±ã€‚

å®¢æˆ·éœ€æ±‚ï¼š{customer_needs}
æ¥¼ç›˜ä¿¡æ¯ï¼š{project_info}
åŒ¹é…è¯„åˆ†ï¼š{scores}

è¦æ±‚ï¼š
1. 2-3å¥è¯è¯´æ˜æ¨èåŸå› 
2. çªå‡ºæœ€åŒ¹é…çš„ç»´åº¦
3. æåŠéœ€è¦æ³¨æ„çš„ç‚¹
4. æ¨èæœ€é€‚åˆçš„æˆ·å‹
`;

interface MatchResult {
  project: Project;
  totalScore: number;
  scores: { dimension: string; score: number }[];
  reason?: string;
  recommendedHouseType?: string;
}
```

### 12.5 APIæ¥å£

```typescript
// ä¸ºå®¢æˆ·åŒ¹é…æ¥¼ç›˜
POST /api/customers/{customerId}/match
Body: { limit?: number; filters?: Record<string, any> }
Response: {
  matches: MatchResult[];
  totalCandidates: number;
}

// è·å–æ¥¼ç›˜æ¨èï¼ˆå¸¦ç¼“å­˜ï¼‰
GET /api/recommendations/{customerId}?refresh=false
Response: {
  matches: MatchResult[];
  generatedAt: string;
  expiresAt: string;
}
```

---

## åä¸‰ã€è´¹ç”¨è®¡ç®—å™¨

### 13.1 è®¡ç®—å¼•æ“

```typescript
// ç­‰é¢æœ¬æ¯æœˆä¾›è®¡ç®—
function calcEqualInstallment(
  principal: number,    // è´·æ¬¾é‡‘é¢ï¼ˆå…ƒï¼‰
  annualRate: number,   // å¹´åˆ©ç‡ï¼ˆå¦‚4.2è¡¨ç¤º4.2%ï¼‰
  years: number         // è´·æ¬¾å¹´é™
): MortgageResult {
  const monthlyRate = annualRate / 100 / 12;
  const months = years * 12;
  const monthlyPayment = principal * monthlyRate *
    Math.pow(1 + monthlyRate, months) /
    (Math.pow(1 + monthlyRate, months) - 1);
  const totalPayment = monthlyPayment * months;
  const totalInterest = totalPayment - principal;

  return {
    monthlyPayment: Math.round(monthlyPayment),
    totalPayment: Math.round(totalPayment),
    totalInterest: Math.round(totalInterest),
    method: 'equal_installment'
  };
}

// ç­‰é¢æœ¬é‡‘æœˆä¾›è®¡ç®—
function calcEqualPrincipal(
  principal: number,
  annualRate: number,
  years: number
): MortgageResult {
  const monthlyRate = annualRate / 100 / 12;
  const months = years * 12;
  const monthlyPrincipal = principal / months;
  const firstMonthPayment = monthlyPrincipal + principal * monthlyRate;
  const lastMonthPayment = monthlyPrincipal + monthlyPrincipal * monthlyRate;
  const totalInterest = (months + 1) * principal * monthlyRate / 2;

  return {
    monthlyPayment: Math.round(firstMonthPayment),  // é¦–æœˆ
    lastMonthPayment: Math.round(lastMonthPayment),  // æœ«æœˆ
    totalPayment: Math.round(principal + totalInterest),
    totalInterest: Math.round(totalInterest),
    method: 'equal_principal'
  };
}

interface MortgageResult {
  monthlyPayment: number;
  lastMonthPayment?: number;
  totalPayment: number;
  totalInterest: number;
  method: 'equal_installment' | 'equal_principal';
}
```

### 13.2 ç¨è´¹è®¡ç®—

```typescript
interface TaxCalcInput {
  totalPrice: number;       // æˆ¿å±‹æ€»ä»·ï¼ˆä¸‡ï¼‰
  area: number;             // é¢ç§¯ï¼ˆã¡ï¼‰
  isFirstHome: boolean;     // æ˜¯å¦é¦–å¥—
  isOver5Years: boolean;    // æ˜¯å¦æ»¡äº”å¹´ï¼ˆäºŒæ‰‹æˆ¿ï¼‰
  isUnique: boolean;        // æ˜¯å¦å”¯ä¸€ï¼ˆäºŒæ‰‹æˆ¿ï¼‰
  isNewHome: boolean;       // æ–°æˆ¿/äºŒæ‰‹æˆ¿
}

interface TaxResult {
  deedTax: number;          // å¥‘ç¨
  vatTax: number;           // å¢å€¼ç¨
  incomeTax: number;        // ä¸ªäººæ‰€å¾—ç¨
  agencyFee: number;        // ä¸­ä»‹è´¹
  otherFees: number;        // å…¶ä»–è´¹ç”¨
  totalFees: number;        // æ€»è´¹ç”¨
  breakdown: { name: string; amount: number; rate: string }[];
}

function calcTax(input: TaxCalcInput): TaxResult {
  const { totalPrice, area, isFirstHome, isOver5Years, isUnique, isNewHome } = input;
  const priceYuan = totalPrice * 10000;

  // å¥‘ç¨
  let deedTaxRate: number;
  if (isFirstHome && area <= 90) deedTaxRate = 0.01;
  else if (isFirstHome && area > 90) deedTaxRate = 0.015;
  else deedTaxRate = 0.03;
  const deedTax = priceYuan * deedTaxRate;

  // å¢å€¼ç¨ï¼ˆäºŒæ‰‹æˆ¿ï¼Œæ»¡2å¹´å…å¾ï¼‰
  const vatTax = (!isNewHome && !isOver5Years)
    ? priceYuan * 0.053 : 0;

  // ä¸ªäººæ‰€å¾—ç¨ï¼ˆæ»¡äº”å”¯ä¸€å…å¾ï¼‰
  const incomeTax = (!isNewHome && !(isOver5Years && isUnique))
    ? priceYuan * 0.01 : 0;

  // ä¸­ä»‹è´¹ï¼ˆäºŒæ‰‹æˆ¿ï¼‰
  const agencyFee = isNewHome ? 0 : priceYuan * 0.02;

  // å…¶ä»–è´¹ç”¨ï¼ˆæƒè¯ã€è¯„ä¼°ç­‰ï¼‰
  const otherFees = 5000;

  const totalFees = deedTax + vatTax + incomeTax + agencyFee + otherFees;

  return {
    deedTax, vatTax, incomeTax, agencyFee, otherFees, totalFees,
    breakdown: [
      { name: 'å¥‘ç¨', amount: deedTax, rate: `${deedTaxRate * 100}%` },
      { name: 'å¢å€¼ç¨', amount: vatTax, rate: vatTax > 0 ? '5.3%' : 'å…å¾' },
      { name: 'ä¸ªç¨', amount: incomeTax, rate: incomeTax > 0 ? '1%' : 'å…å¾' },
      { name: 'ä¸­ä»‹è´¹', amount: agencyFee, rate: agencyFee > 0 ? '2%' : 'æ— ' },
      { name: 'å…¶ä»–', amount: otherFees, rate: 'å›ºå®š' },
    ]
  };
}
```

### 13.3 é¦–ä»˜è®¡ç®—

```typescript
interface DownPaymentInput {
  totalPrice: number;           // æˆ¿å±‹æ€»ä»·ï¼ˆä¸‡ï¼‰
  isFirstHome: boolean;         // æ˜¯å¦é¦–å¥—
  providentFundBalance?: number; // å…¬ç§¯é‡‘ä½™é¢ï¼ˆä¸‡ï¼‰
  loanYears?: number;           // è´·æ¬¾å¹´é™
}

function calcDownPayment(input: DownPaymentInput): DownPaymentResult {
  const ratio = input.isFirstHome ? 0.3 : 0.5;
  const downPayment = input.totalPrice * ratio;
  const loanAmount = input.totalPrice - downPayment;
  const years = input.loanYears || 30;

  const mortgage = calcEqualInstallment(
    loanAmount * 10000,
    getCurrentLPR(),
    years
  );

  return {
    downPaymentRatio: ratio,
    downPayment,
    loanAmount,
    monthlyPayment: mortgage.monthlyPayment,
    providentFundDeduction: input.providentFundBalance || 0,
    actualDownPayment: downPayment - (input.providentFundBalance || 0),
  };
}

// LPRåˆ©ç‡ç®¡ç†
interface LPRConfig {
  rate5YearAbove: number;   // 5å¹´æœŸä»¥ä¸ŠLPR
  rate5YearBelow: number;   // 5å¹´æœŸä»¥ä¸‹LPR
  updatedAt: Date;
}

function getCurrentLPR(): number {
  // ä»é…ç½®ä¸­è·å–æœ€æ–°LPRåˆ©ç‡
  return config.get<number>('lpr.rate5YearAbove', 3.95);
}
```

### 13.4 è‡ªç„¶è¯­è¨€è§¦å‘

```typescript
// ä»å¯¹è¯ä¸­è¯†åˆ«è®¡ç®—æ„å›¾
const calcIntentPrompt = `
åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æƒ³è¿›è¡Œè´¹ç”¨è®¡ç®—ï¼Œè¿”å›JSONï¼š
{
  "isCalcRequest": true/false,
  "calcType": "mortgage|tax|downpayment",
  "params": {
    "totalPrice": æ•°å­—ï¼ˆä¸‡ï¼‰,
    "loanAmount": æ•°å­—ï¼ˆä¸‡ï¼‰,
    "years": æ•°å­—,
    "area": æ•°å­—ï¼ˆã¡ï¼‰,
    "isFirstHome": true/false
  }
}

ç”¨æˆ·è¾“å…¥ï¼š{query}
`;
```

### 13.5 APIæ¥å£

```typescript
// æœˆä¾›è®¡ç®—
POST /api/calculator/mortgage
Body: {
  loanAmount: number;       // è´·æ¬¾é‡‘é¢ï¼ˆä¸‡ï¼‰
  years: number;            // è´·æ¬¾å¹´é™
  rate?: number;            // åˆ©ç‡ï¼ˆé»˜è®¤LPRï¼‰
  method: 'equal_installment' | 'equal_principal';
}
Response: MortgageResult

// ç¨è´¹è®¡ç®—
POST /api/calculator/tax
Body: TaxCalcInput
Response: TaxResult

// é¦–ä»˜è®¡ç®—
POST /api/calculator/downpayment
Body: DownPaymentInput
Response: DownPaymentResult

// è·å–å½“å‰LPRåˆ©ç‡
GET /api/calculator/lpr
Response: LPRConfig
```

---

## åå››ã€å¤šæ¸ é“æ¶ˆæ¯ä¸­å¿ƒ

### 14.1 æ¶ˆæ¯èšåˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾®ä¿¡     â”‚ â”‚ ä¼ä¸šå¾®ä¿¡  â”‚ â”‚  æŠ–éŸ³    â”‚ â”‚ å°çº¢ä¹¦    â”‚
â”‚ Webhook  â”‚ â”‚ Webhook  â”‚ â”‚  API     â”‚ â”‚  API     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   æ¶ˆæ¯ç½‘å…³        â”‚
              â”‚  ç»Ÿä¸€æ ¼å¼è½¬æ¢     â”‚
              â”‚  æ¶ˆæ¯å»é‡/æ’åº    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   æ¶ˆæ¯é˜Ÿåˆ—        â”‚
              â”‚  Redis Stream    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   æ¶ˆæ¯å¤„ç†å™¨      â”‚
              â”‚  å­˜å‚¨/é€šçŸ¥/AIåˆ†æ â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.2 ç»Ÿä¸€æ¶ˆæ¯æ¨¡å‹

```typescript
interface UnifiedMessage {
  id: string;
  agentId: string;              // ç»çºªäººID
  channel: 'wechat' | 'wecom' | 'douyin' | 'xiaohongshu' | 'sms';
  direction: 'inbound' | 'outbound';

  // å‘é€æ–¹
  sender: {
    id: string;                 // æ¸ é“å†…ç”¨æˆ·ID
    name: string;
    avatar?: string;
  };

  // æ¶ˆæ¯å†…å®¹
  content: {
    type: 'text' | 'image' | 'voice' | 'video' | 'link' | 'location';
    text?: string;
    mediaUrl?: string;
    metadata?: Record<string, any>;
  };

  // å…³è”
  customerId?: string;          // å…³è”å®¢æˆ·ID
  conversationId: string;       // ä¼šè¯ID
  replyToId?: string;           // å›å¤çš„æ¶ˆæ¯ID

  // çŠ¶æ€
  status: 'received' | 'read' | 'replied' | 'archived';
  isImportant: boolean;
  createdAt: Date;
}

interface Conversation {
  id: string;
  agentId: string;
  channel: string;
  customerId?: string;
  lastMessageAt: Date;
  unreadCount: number;
  messages: UnifiedMessage[];
}
```

### 14.3 æ¸ é“é€‚é…å™¨

```typescript
interface ChannelAdapter {
  channel: string;
  parseInbound(rawData: any): UnifiedMessage;
  formatOutbound(message: UnifiedMessage): any;
  sendMessage(to: string, content: any): Promise<boolean>;
  verifyWebhook(req: Request): boolean;
}

// å¾®ä¿¡é€‚é…å™¨
class WechatAdapter implements ChannelAdapter {
  channel = 'wechat';

  parseInbound(rawData: WechatMessage): UnifiedMessage {
    return {
      id: generateId(),
      channel: 'wechat',
      direction: 'inbound',
      sender: {
        id: rawData.FromUserName,
        name: rawData.FromUserName,
      },
      content: {
        type: mapWechatMsgType(rawData.MsgType),
        text: rawData.Content,
        mediaUrl: rawData.MediaId ? resolveMediaUrl(rawData.MediaId) : undefined,
      },
      conversationId: `wechat_${rawData.FromUserName}`,
      status: 'received',
      isImportant: false,
      createdAt: new Date(rawData.CreateTime * 1000),
    } as UnifiedMessage;
  }

  async sendMessage(to: string, content: any): Promise<boolean> {
    return await wechatApi.sendCustomMessage(to, content);
  }
}

// é€‚é…å™¨æ³¨å†Œ
const adapters: Record<string, ChannelAdapter> = {
  wechat: new WechatAdapter(),
  wecom: new WecomAdapter(),
  douyin: new DouyinAdapter(),
  xiaohongshu: new XiaohongshuAdapter(),
};
```

### 14.4 æ™ºèƒ½å›å¤

```typescript
interface SmartReplyRequest {
  conversationId: string;
  inboundMessage: UnifiedMessage;
  customerProfile?: Customer;
}

async function generateSmartReply(
  req: SmartReplyRequest
): Promise<string[]> {
  // è·å–ä¼šè¯å†å²
  const history = await db.messages.findMany({
    where: { conversationId: req.conversationId },
    orderBy: { createdAt: 'desc' },
    take: 10
  });

  const prompt = `
ä½ æ˜¯æˆ¿äº§ç»çºªäººçš„AIåŠ©æ‰‹ã€‚æ ¹æ®å®¢æˆ·æ¶ˆæ¯å’Œä¼šè¯å†å²ï¼Œç”Ÿæˆ3æ¡å€™é€‰å›å¤ã€‚

å®¢æˆ·æ¶ˆæ¯ï¼š${req.inboundMessage.content.text}
ä¼šè¯å†å²ï¼š${formatHistory(history)}
${req.customerProfile ? `å®¢æˆ·ä¿¡æ¯ï¼š${JSON.stringify(req.customerProfile)}` : ''}

è¦æ±‚ï¼š
1. å›å¤ä¸“ä¸šã€äº²åˆ‡
2. ç¬¬ä¸€æ¡æœ€æ¨èï¼Œåä¸¤æ¡ä¸ºå¤‡é€‰
3. æ¯æ¡ä¸è¶…è¿‡100å­—
è¿”å›JSONæ•°ç»„ï¼š["å›å¤1", "å›å¤2", "å›å¤3"]
`;

  const response = await aiService.generate(prompt);
  return JSON.parse(response);
}
```

### 14.5 å¿«æ·å›å¤æ¨¡æ¿

```typescript
interface QuickReply {
  id: string;
  agentId: string;
  category: string;           // åˆ†ç±»ï¼šé—®å€™/æŠ¥ä»·/çº¦çœ‹/è·Ÿè¿›
  title: string;              // æ¨¡æ¿æ ‡é¢˜
  content: string;            // æ¨¡æ¿å†…å®¹ï¼ˆæ”¯æŒå˜é‡ï¼‰
  variables?: string[];       // å¯æ›¿æ¢å˜é‡
  usageCount: number;
}

// å˜é‡æ›¿æ¢
function renderTemplate(
  template: string,
  vars: Record<string, string>
): string {
  return template.replace(/\{(\w+)\}/g, (_, key) => vars[key] || `{${key}}`);
}
```

### 14.6 APIæ¥å£

```typescript
// Webhookæ¥æ”¶ï¼ˆå„æ¸ é“ï¼‰
POST /api/webhooks/{channel}

// è·å–ä¼šè¯åˆ—è¡¨
GET /api/conversations?channel=wechat&status=unread&page=1
Response: { conversations: Conversation[]; total: number }

// è·å–ä¼šè¯æ¶ˆæ¯
GET /api/conversations/{id}/messages?limit=20&before={messageId}
Response: { messages: UnifiedMessage[] }

// å‘é€æ¶ˆæ¯
POST /api/conversations/{id}/messages
Body: { content: { type: string; text?: string; mediaUrl?: string } }

// è·å–æ™ºèƒ½å›å¤å»ºè®®
POST /api/conversations/{id}/smart-reply
Response: { suggestions: string[] }

// å¿«æ·å›å¤æ¨¡æ¿
GET /api/quick-replies?category=greeting
POST /api/quick-replies
Body: QuickReply
```

---

## åäº”ã€AIå¸¦çœ‹åŠ©æ‰‹

### 15.1 å¸¦çœ‹æµç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å¸¦çœ‹å‰                                 â”‚
â”‚  åˆ›å»ºå¸¦çœ‹è®¡åˆ’ â†’ ç”Ÿæˆå‡†å¤‡æ¸…å• â†’ å®šåˆ¶è¯æœ¯ â†’ è§„åˆ’è·¯çº¿            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å¸¦çœ‹ä¸­                                 â”‚
â”‚  å®æ—¶æŸ¥è¯¢ â†’ ç«å“å¯¹æ¯” â†’ è´¹ç”¨è®¡ç®— â†’ å¼‚è®®åº”å¯¹                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å¸¦çœ‹å                                 â”‚
â”‚  ç”Ÿæˆæ€»ç»“ â†’ æ„å‘è¯„ä¼° â†’ è·Ÿè¿›å»ºè®® â†’ æ›´æ–°å®¢æˆ·æ¡£æ¡ˆ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 15.2 æ•°æ®ç»“æ„

```typescript
interface TourPlan {
  id: string;
  agentId: string;
  customerId: string;
  scheduledAt: Date;
  status: 'planned' | 'in_progress' | 'completed' | 'cancelled';

  // å¸¦çœ‹æ¥¼ç›˜
  projects: {
    projectId: string;
    order: number;              // å‚è§‚é¡ºåº
    houseTypeIds: string[];     // è¦çœ‹çš„æˆ·å‹
    estimatedDuration: number;  // é¢„è®¡æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  }[];

  // AIç”Ÿæˆå†…å®¹
  preparation?: TourPreparation;
  summary?: TourSummary;

  createdAt: Date;
  updatedAt: Date;
}

interface TourPreparation {
  customerBrief: string;        // å®¢æˆ·ç®€å†µ
  focusPoints: string[];        // å®¢æˆ·å…³æ³¨ç‚¹é¢„æµ‹
  customScripts: {              // é’ˆå¯¹æ€§è¯æœ¯
    projectId: string;
    script: string;
    objections: { question: string; answer: string }[];
  }[];
  routeSuggestion: string;      // è·¯çº¿å»ºè®®
  timeAllocation: { projectName: string; minutes: number }[];
}

interface TourSummary {
  duration: number;             // å®é™…æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  projectsFeedback: {
    projectId: string;
    projectName: string;
    interest: 'high' | 'medium' | 'low';
    feedback: string;           // å®¢æˆ·åé¦ˆ
    concerns: string[];         // å®¢æˆ·é¡¾è™‘
  }[];
  overallAssessment: string;    // æ•´ä½“è¯„ä¼°
  nextSteps: string[];          // ä¸‹ä¸€æ­¥å»ºè®®
  followUpDate: Date;           // å»ºè®®è·Ÿè¿›æ—¥æœŸ
  followUpScript: string;       // è·Ÿè¿›è¯æœ¯
}
```

### 15.3 å¸¦çœ‹å‰å‡†å¤‡ç”Ÿæˆ

```typescript
async function generatePreparation(
  plan: TourPlan
): Promise<TourPreparation> {
  const customer = await db.customers.findUnique({
    where: { id: plan.customerId }
  });
  const projects = await db.projects.findMany({
    where: { id: { in: plan.projects.map(p => p.projectId) } },
    include: { houseTypes: true, facilities: true }
  });

  const prompt = `
ä½ æ˜¯èµ„æ·±æˆ¿äº§ç»çºªäººåŠ©æ‰‹ã€‚æ ¹æ®å®¢æˆ·ä¿¡æ¯å’Œå¾…çœ‹æ¥¼ç›˜ï¼Œç”Ÿæˆå¸¦çœ‹å‡†å¤‡ææ–™ã€‚

## å®¢æˆ·ä¿¡æ¯
${JSON.stringify(customer)}

## å¾…çœ‹æ¥¼ç›˜
${projects.map(p => JSON.stringify(p)).join('\n')}

## è¯·ç”Ÿæˆ
1. å®¢æˆ·ç®€å†µï¼ˆ50å­—å†…ï¼‰
2. å®¢æˆ·å¯èƒ½å…³æ³¨çš„3-5ä¸ªé‡ç‚¹
3. æ¯ä¸ªæ¥¼ç›˜çš„é’ˆå¯¹æ€§è¯æœ¯ï¼ˆçªå‡ºä¸å®¢æˆ·éœ€æ±‚åŒ¹é…çš„å–ç‚¹ï¼‰
4. æ¯ä¸ªæ¥¼ç›˜å¯èƒ½é‡åˆ°çš„å¼‚è®®åŠåº”å¯¹
5. å‚è§‚è·¯çº¿å»ºè®®å’Œæ—¶é—´åˆ†é…

è¿”å›JSONæ ¼å¼ã€‚
`;

  const result = await aiService.generate(prompt);
  return JSON.parse(result);
}
```

### 15.4 å¸¦çœ‹ä¸­å®æ—¶æŸ¥è¯¢

```typescript
interface TourQuery {
  tourId: string;
  question: string;
  context?: {
    currentProjectId?: string;
    currentHouseTypeId?: string;
  };
}

async function handleTourQuery(query: TourQuery): Promise<string> {
  const tour = await db.tourPlans.findUnique({
    where: { id: query.tourId },
    include: { customer: true }
  });

  // è¯†åˆ«æŸ¥è¯¢ç±»å‹å¹¶è·¯ç”±
  const intent = await classifyTourQueryIntent(query.question);

  switch (intent) {
    case 'property_info':
      return await queryProjectInfo(parseQuery(query.question));
    case 'comparison':
      return await generateComparison(query.context);
    case 'calculation':
      return await handleCalculation(query.question);
    case 'objection':
      return await generateObjectionResponse(
        query.question, query.context?.currentProjectId
      );
    default:
      return await aiService.generate(
        `å›ç­”ç»çºªäººåœ¨å¸¦çœ‹è¿‡ç¨‹ä¸­çš„é—®é¢˜ï¼š${query.question}`
      );
  }
}
```

### 15.5 å¸¦çœ‹åæ€»ç»“ç”Ÿæˆ

```typescript
async function generateTourSummary(
  tourId: string,
  feedbackInput: {
    projectId: string;
    interest: 'high' | 'medium' | 'low';
    notes: string;
  }[]
): Promise<TourSummary> {
  const tour = await db.tourPlans.findUnique({
    where: { id: tourId },
    include: { customer: true }
  });

  const prompt = `
æ ¹æ®å¸¦çœ‹æƒ…å†µç”Ÿæˆæ€»ç»“æŠ¥å‘Šå’Œè·Ÿè¿›å»ºè®®ã€‚

å®¢æˆ·ï¼š${tour.customer.name}
çœ‹æˆ¿åé¦ˆï¼š
${feedbackInput.map(f => `- ${f.projectId}: æ„å‘${f.interest}, ${f.notes}`).join('\n')}

è¯·ç”Ÿæˆï¼š
1. æ¯ä¸ªæ¥¼ç›˜çš„å®¢æˆ·åé¦ˆæ€»ç»“å’Œé¡¾è™‘ç‚¹
2. æ•´ä½“æ„å‘è¯„ä¼°
3. å…·ä½“çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®ï¼ˆ3-5æ¡ï¼‰
4. å»ºè®®è·Ÿè¿›æ—¥æœŸ
5. è·Ÿè¿›è¯æœ¯ï¼ˆ100å­—å†…ï¼‰

è¿”å›JSONæ ¼å¼ã€‚
`;

  const summary = JSON.parse(await aiService.generate(prompt));

  // è‡ªåŠ¨æ›´æ–°å®¢æˆ·çŠ¶æ€
  await db.customers.update({
    where: { id: tour.customerId },
    data: {
      status: 'toured',
      lastContactAt: new Date(),
      nextFollowUpAt: summary.followUpDate,
    }
  });

  return summary;
}
```

### 15.6 APIæ¥å£

```typescript
// åˆ›å»ºå¸¦çœ‹è®¡åˆ’
POST /api/tours
Body: {
  customerId: string;
  scheduledAt: string;
  projects: { projectId: string; houseTypeIds: string[] }[];
}
Response: TourPlan

// ç”Ÿæˆå¸¦çœ‹å‡†å¤‡
POST /api/tours/{tourId}/prepare
Response: TourPreparation

// å¸¦çœ‹ä¸­å®æ—¶æŸ¥è¯¢
POST /api/tours/{tourId}/query
Body: { question: string; context?: any }
Response: { answer: string }

// æäº¤å¸¦çœ‹åé¦ˆå¹¶ç”Ÿæˆæ€»ç»“
POST /api/tours/{tourId}/summary
Body: {
  feedback: { projectId: string; interest: string; notes: string }[];
}
Response: TourSummary

// è·å–å¸¦çœ‹å†å²
GET /api/tours?customerId={id}&status=completed&page=1
Response: { tours: TourPlan[]; total: number }
```

---

## åå…­ã€è®¤è¯æˆæƒç³»ç»Ÿ

### 16.1 è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç™»å½•  â”‚â”€â”€â”€â–¶â”‚  éªŒè¯æ‰‹æœºå·   â”‚â”€â”€â”€â–¶â”‚  å‘é€éªŒè¯ç    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›Tokenâ”‚â—€â”€â”€â”‚  ç”ŸæˆJWT     â”‚â—€â”€â”€â”‚  éªŒè¯ç æ ¡éªŒ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 16.2 JWT Tokenç®¡ç†

```typescript
interface JWTPayload {
  userId: string;
  role: 'agent' | 'team_leader' | 'admin';
  teamId?: string;
  iat: number;
  exp: number;
}

// Tokené…ç½®
const tokenConfig = {
  accessToken: {
    secret: process.env.JWT_SECRET,
    expiresIn: '2h',
  },
  refreshToken: {
    secret: process.env.JWT_REFRESH_SECRET,
    expiresIn: '7d',
  }
};

// ç”ŸæˆTokenå¯¹
function generateTokenPair(user: User): TokenPair {
  const payload: JWTPayload = {
    userId: user.id,
    role: user.role,
    teamId: user.teamId,
    iat: Math.floor(Date.now() / 1000),
    exp: 0, // ç”±jwt.signè®¾ç½®
  };

  return {
    accessToken: jwt.sign(payload, tokenConfig.accessToken.secret,
      { expiresIn: tokenConfig.accessToken.expiresIn }),
    refreshToken: jwt.sign(payload, tokenConfig.refreshToken.secret,
      { expiresIn: tokenConfig.refreshToken.expiresIn }),
  };
}
```

### 16.3 RBACæƒé™æ§åˆ¶

```typescript
type Role = 'agent' | 'team_leader' | 'admin';

const permissions: Record<Role, string[]> = {
  agent: [
    'project:read', 'project:create', 'project:update',
    'material:read', 'material:upload',
    'content:generate', 'content:read',
    'customer:read', 'customer:create', 'customer:update',
    'tour:read', 'tour:create', 'tour:update',
    'profile:read', 'profile:update',
    'calculator:use', 'query:use',
  ],
  team_leader: [
    // ç»§æ‰¿agentæ‰€æœ‰æƒé™
    'team:read', 'team:manage',
    'agent:read',                    // æŸ¥çœ‹å›¢é˜Ÿæˆå‘˜æ•°æ®
    'report:team',                   // å›¢é˜ŸæŠ¥è¡¨
  ],
  admin: [
    // ç»§æ‰¿æ‰€æœ‰æƒé™
    'user:manage', 'system:config',
    'report:all',
  ],
};

// æƒé™ä¸­é—´ä»¶
function requirePermission(permission: string) {
  return (req: Request, res: Response, next: NextFunction) => {
    const user = req.user as JWTPayload;
    const rolePerms = getAllPermissions(user.role);
    if (!rolePerms.includes(permission)) {
      return res.status(403).json({ error: 'FORBIDDEN' });
    }
    next();
  };
}
```

### 16.4 æ•°æ®éš”ç¦»

```typescript
// ç»çºªäººåªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
function scopeToAgent(query: any, userId: string): any {
  return { ...query, where: { ...query.where, agentId: userId } };
}

// å›¢é˜Ÿé•¿å¯ä»¥è®¿é—®å›¢é˜Ÿæ•°æ®
function scopeToTeam(query: any, teamId: string): any {
  return { ...query, where: { ...query.where, agent: { teamId } } };
}
```

### 16.5 APIæ¥å£

```typescript
// å‘é€éªŒè¯ç 
POST /api/auth/sms-code
Body: { phone: string }

// éªŒè¯ç ç™»å½•
POST /api/auth/login
Body: { phone: string; code: string }
Response: { accessToken: string; refreshToken: string; user: User }

// åˆ·æ–°Token
POST /api/auth/refresh
Body: { refreshToken: string }
Response: { accessToken: string; refreshToken: string }

// é€€å‡ºç™»å½•
POST /api/auth/logout
```

---

## åä¸ƒã€é”™è¯¯å¤„ç†ç­–ç•¥

### 17.1 é”™è¯¯åˆ†ç±»

```typescript
enum ErrorCode {
  // å®¢æˆ·ç«¯é”™è¯¯ 4xx
  BAD_REQUEST = 'BAD_REQUEST',
  UNAUTHORIZED = 'UNAUTHORIZED',
  FORBIDDEN = 'FORBIDDEN',
  NOT_FOUND = 'NOT_FOUND',
  RATE_LIMITED = 'RATE_LIMITED',
  VALIDATION_ERROR = 'VALIDATION_ERROR',

  // AIæœåŠ¡é”™è¯¯ 5xx
  AI_SERVICE_UNAVAILABLE = 'AI_SERVICE_UNAVAILABLE',
  AI_GENERATION_FAILED = 'AI_GENERATION_FAILED',
  AI_CONTENT_FILTERED = 'AI_CONTENT_FILTERED',
  AI_QUOTA_EXCEEDED = 'AI_QUOTA_EXCEEDED',

  // å¤–éƒ¨æœåŠ¡é”™è¯¯
  SMS_SEND_FAILED = 'SMS_SEND_FAILED',
  FILE_UPLOAD_FAILED = 'FILE_UPLOAD_FAILED',
  CHANNEL_API_ERROR = 'CHANNEL_API_ERROR',

  // ç³»ç»Ÿé”™è¯¯
  INTERNAL_ERROR = 'INTERNAL_ERROR',
  DATABASE_ERROR = 'DATABASE_ERROR',
}

interface ApiError {
  code: ErrorCode;
  message: string;              // ç”¨æˆ·å¯è§çš„é”™è¯¯ä¿¡æ¯
  detail?: string;              // å¼€å‘è°ƒè¯•ä¿¡æ¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
  requestId: string;            // è¯·æ±‚è¿½è¸ªID
}
```

### 17.2 AIæœåŠ¡é™çº§ç­–ç•¥

```typescript
interface FallbackChain {
  primary: string;              // ä¸»æ¨¡å‹
  fallbacks: string[];          // é™çº§æ¨¡å‹åˆ—è¡¨
  maxRetries: number;
  retryDelay: number;           // æ¯«ç§’
}

const aiServiceFallback: FallbackChain = {
  primary: 'claude-sonnet-4-20250514',
  fallbacks: ['gpt-4o', 'deepseek-chat'],
  maxRetries: 2,
  retryDelay: 1000,
};

async function callWithFallback<T>(
  fn: (model: string) => Promise<T>,
  chain: FallbackChain
): Promise<T> {
  const models = [chain.primary, ...chain.fallbacks];

  for (let i = 0; i < models.length; i++) {
    for (let retry = 0; retry <= chain.maxRetries; retry++) {
      try {
        return await fn(models[i]);
      } catch (error) {
        const isLastModel = i === models.length - 1;
        const isLastRetry = retry === chain.maxRetries;

        if (isLastModel && isLastRetry) throw error;
        if (isLastRetry) break; // åˆ‡æ¢ä¸‹ä¸€ä¸ªæ¨¡å‹

        await sleep(chain.retryDelay * (retry + 1));
      }
    }
  }
  throw new Error('AI_SERVICE_UNAVAILABLE');
}
```

### 17.3 å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶

```typescript
function errorHandler(err: Error, req: Request, res: Response, next: NextFunction) {
  const requestId = req.headers['x-request-id'] || generateId();

  // è®°å½•é”™è¯¯æ—¥å¿—
  logger.error({
    requestId,
    method: req.method,
    path: req.path,
    error: err.message,
    stack: err.stack,
    userId: req.user?.userId,
  });

  // å·²çŸ¥ä¸šåŠ¡é”™è¯¯
  if (err instanceof AppError) {
    return res.status(err.statusCode).json({
      code: err.code,
      message: err.message,
      requestId,
    });
  }

  // æœªçŸ¥é”™è¯¯
  res.status(500).json({
    code: ErrorCode.INTERNAL_ERROR,
    message: 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•',
    requestId,
  });
}

---

## åå…«ã€é™æµä¸ç¼“å­˜ç­–ç•¥

### 18.1 APIé™æµ

```typescript
interface RateLimitConfig {
  windowMs: number;             // æ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼‰
  maxRequests: number;          // æœ€å¤§è¯·æ±‚æ•°
  keyGenerator: (req: Request) => string;
}

const rateLimits: Record<string, RateLimitConfig> = {
  // é€šç”¨APIé™æµ
  general: {
    windowMs: 60 * 1000,        // 1åˆ†é’Ÿ
    maxRequests: 60,
    keyGenerator: (req) => req.user?.userId || req.ip,
  },
  // å†…å®¹ç”Ÿæˆé™æµï¼ˆæ¶ˆè€—AIèµ„æºï¼‰
  contentGeneration: {
    windowMs: 60 * 1000,
    maxRequests: 10,
    keyGenerator: (req) => req.user?.userId,
  },
  // éªŒè¯ç é™æµ
  smsCode: {
    windowMs: 60 * 1000,
    maxRequests: 1,
    keyGenerator: (req) => req.body.phone,
  },
};

// åŸºäºRedisçš„æ»‘åŠ¨çª—å£é™æµ
async function checkRateLimit(
  key: string,
  config: RateLimitConfig
): Promise<{ allowed: boolean; remaining: number; resetAt: number }> {
  const now = Date.now();
  const windowStart = now - config.windowMs;

  // ç§»é™¤è¿‡æœŸè®°å½•ï¼Œæ·»åŠ å½“å‰è¯·æ±‚ï¼Œç»Ÿè®¡çª—å£å†…è¯·æ±‚æ•°
  const pipeline = redis.pipeline();
  pipeline.zremrangebyscore(key, 0, windowStart);
  pipeline.zadd(key, now, `${now}`);
  pipeline.zcard(key);
  pipeline.expire(key, Math.ceil(config.windowMs / 1000));

  const results = await pipeline.exec();
  const count = results[2][1] as number;

  return {
    allowed: count <= config.maxRequests,
    remaining: Math.max(0, config.maxRequests - count),
    resetAt: now + config.windowMs,
  };
}
```

### 18.2 AIé…é¢ç®¡ç†

```typescript
interface QuotaPlan {
  plan: 'free' | 'basic' | 'pro' | 'enterprise';
  daily: {
    contentGeneration: number;  // å†…å®¹ç”Ÿæˆæ¬¡æ•°
    queryCount: number;         // æŸ¥è¯¢æ¬¡æ•°
    matchCount: number;         // åŒ¹é…æ¬¡æ•°
  };
  monthly: {
    totalTokens: number;        // æ€»Tokenæ•°
    pptGeneration: number;      // PPTç”Ÿæˆæ¬¡æ•°
    posterGeneration: number;   // æµ·æŠ¥ç”Ÿæˆæ¬¡æ•°
  };
}

const quotaPlans: Record<string, QuotaPlan> = {
  free:       { plan: 'free',       daily: { contentGeneration: 5,   queryCount: 20,  matchCount: 5  }, monthly: { totalTokens: 100000,    pptGeneration: 2,   posterGeneration: 5  } },
  basic:      { plan: 'basic',      daily: { contentGeneration: 30,  queryCount: 100, matchCount: 20 }, monthly: { totalTokens: 1000000,   pptGeneration: 20,  posterGeneration: 50 } },
  pro:        { plan: 'pro',        daily: { contentGeneration: 100, queryCount: 500, matchCount: 50 }, monthly: { totalTokens: 5000000,   pptGeneration: 100, posterGeneration: 200 } },
  enterprise: { plan: 'enterprise', daily: { contentGeneration: -1,  queryCount: -1,  matchCount: -1 }, monthly: { totalTokens: -1,        pptGeneration: -1,  posterGeneration: -1 } },
};

// é…é¢æ£€æŸ¥
async function checkQuota(
  userId: string,
  action: string
): Promise<boolean> {
  const user = await db.users.findUnique({ where: { id: userId } });
  const plan = quotaPlans[user.plan];
  const usage = await getUsage(userId, action);

  const limit = plan.daily[action] ?? plan.monthly[action];
  if (limit === -1) return true; // æ— é™åˆ¶
  return usage < limit;
}
```

### 18.3 ç¼“å­˜ç­–ç•¥

```typescript
interface CacheConfig {
  key: string;
  ttl: number;                  // ç§’
  staleWhileRevalidate?: number; // è¿‡æœŸåä»å¯ä½¿ç”¨çš„æ—¶é—´
}

const cacheConfigs: Record<string, CacheConfig> = {
  // æ¥¼ç›˜åŸºç¡€ä¿¡æ¯ï¼ˆå˜åŒ–å°‘ï¼Œé•¿ç¼“å­˜ï¼‰
  projectInfo:      { key: 'project:{id}',           ttl: 3600,  staleWhileRevalidate: 600 },
  // æˆ·å‹ä¿¡æ¯
  houseTypes:       { key: 'project:{id}:types',     ttl: 3600 },
  // æ¥¼ç›˜åŒ¹é…ç»“æœï¼ˆä¸ªæ€§åŒ–ï¼ŒçŸ­ç¼“å­˜ï¼‰
  matchResults:     { key: 'match:{customerId}',     ttl: 300 },
  // LPRåˆ©ç‡ï¼ˆæ¯æœˆæ›´æ–°ï¼‰
  lprRate:          { key: 'lpr:current',             ttl: 86400 },
  // ç”¨æˆ·é…é¢ä½¿ç”¨é‡
  dailyUsage:       { key: 'usage:{userId}:{date}',  ttl: 86400 },
  // å¿«æ·å›å¤æ¨¡æ¿
  quickReplies:     { key: 'replies:{agentId}',      ttl: 1800 },
};

// ç¼“å­˜è¯»å–ï¼ˆæ”¯æŒstale-while-revalidateï¼‰
async function cacheGet<T>(
  config: CacheConfig,
  params: Record<string, string>,
  fetcher: () => Promise<T>
): Promise<T> {
  const key = interpolateKey(config.key, params);
  const cached = await redis.get(key);

  if (cached) return JSON.parse(cached);

  const data = await fetcher();
  await redis.setex(key, config.ttl, JSON.stringify(data));
  return data;
}

// ç¼“å­˜å¤±æ•ˆ
async function cacheInvalidate(pattern: string): Promise<void> {
  const keys = await redis.keys(pattern);
  if (keys.length > 0) await redis.del(...keys);
}
```

---

## åä¹ã€å®Œæ•´æ•°æ®åº“Schema

PRDä¸­å·²å®šä¹‰ projectsã€house_typesã€materialsã€customersã€generated_contents äº”å¼ è¡¨ã€‚ä»¥ä¸‹è¡¥å……ç¼ºå¤±çš„è¡¨å®šä¹‰ã€‚

### 19.1 ç”¨æˆ·è¡¨ (users)

```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  phone TEXT UNIQUE NOT NULL,
  name TEXT,
  avatar TEXT,
  role TEXT DEFAULT 'agent',       -- agent/team_leader/admin
  team_id TEXT,
  plan TEXT DEFAULT 'free',        -- free/basic/pro/enterprise
  plan_expires_at DATETIME,
  last_login_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_team ON users(team_id);
```

### 19.2 è·Ÿè¿›è®°å½•è¡¨ (follow_up_records)

```sql
CREATE TABLE follow_up_records (
  id TEXT PRIMARY KEY,
  customer_id TEXT NOT NULL,
  agent_id TEXT NOT NULL,
  type TEXT NOT NULL,               -- call/wechat/tour/meeting/other
  content TEXT,
  result TEXT,
  next_action TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (customer_id) REFERENCES customers(id),
  FOREIGN KEY (agent_id) REFERENCES users(id)
);
CREATE INDEX idx_followup_customer ON follow_up_records(customer_id);
CREATE INDEX idx_followup_agent_date ON follow_up_records(agent_id, created_at);
```

### 19.3 ç»çºªäººIPè¡¨ (agent_profiles)

```sql
CREATE TABLE agent_profiles (
  id TEXT PRIMARY KEY,
  user_id TEXT UNIQUE NOT NULL,
  nickname TEXT,
  cover_image TEXT,
  years_of_experience INTEGER DEFAULT 0,
  specialized_areas TEXT,           -- JSONæ•°ç»„
  specialized_types TEXT,           -- JSONæ•°ç»„
  total_deals INTEGER DEFAULT 0,
  total_clients INTEGER DEFAULT 0,
  style TEXT DEFAULT 'professional',
  slogan TEXT,
  introduction TEXT,
  signature TEXT,
  opening_line TEXT,
  closing_line TEXT,
  watermark_config TEXT,            -- JSON
  qr_code TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 19.4 å¸¦çœ‹è®¡åˆ’è¡¨ (tour_plans)

```sql
CREATE TABLE tour_plans (
  id TEXT PRIMARY KEY,
  agent_id TEXT NOT NULL,
  customer_id TEXT NOT NULL,
  scheduled_at DATETIME,
  status TEXT DEFAULT 'planned',    -- planned/in_progress/completed/cancelled
  projects_config TEXT NOT NULL,    -- JSON: [{projectId, order, houseTypeIds, duration}]
  preparation TEXT,                 -- JSON: TourPreparation
  summary TEXT,                     -- JSON: TourSummary
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (agent_id) REFERENCES users(id),
  FOREIGN KEY (customer_id) REFERENCES customers(id)
);
CREATE INDEX idx_tour_agent_date ON tour_plans(agent_id, scheduled_at);
CREATE INDEX idx_tour_customer ON tour_plans(customer_id);
```

### 19.5 è®²æˆ¿è¯æœ¯è¡¨ (tour_scripts)

```sql
CREATE TABLE tour_scripts (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  scene TEXT NOT NULL,              -- sandbox/showroom/garden/surrounding
  house_type_id TEXT,
  duration TEXT,                    -- short/standard/detailed
  sections TEXT NOT NULL,           -- JSON: è¯æœ¯åˆ†æ®µå†…å®¹
  total_duration TEXT,
  agent_id TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (project_id) REFERENCES projects(id),
  FOREIGN KEY (agent_id) REFERENCES users(id)
);
CREATE INDEX idx_script_project ON tour_scripts(project_id);
```

### 19.6 PPTä»»åŠ¡è¡¨ (ppt_tasks)

```sql
CREATE TABLE ppt_tasks (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  agent_id TEXT NOT NULL,
  template_id TEXT,
  options TEXT NOT NULL,            -- JSON: ç”Ÿæˆé€‰é¡¹
  status TEXT DEFAULT 'processing', -- processing/completed/failed
  progress INTEGER DEFAULT 0,
  result_pptx_url TEXT,
  result_pdf_url TEXT,
  preview_images TEXT,              -- JSONæ•°ç»„
  error_message TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  completed_at DATETIME,
  FOREIGN KEY (project_id) REFERENCES projects(id),
  FOREIGN KEY (agent_id) REFERENCES users(id)
);
CREATE INDEX idx_ppt_agent ON ppt_tasks(agent_id);
```

### 19.7 æµ·æŠ¥è¡¨ (posters)

```sql
CREATE TABLE posters (
  id TEXT PRIMARY KEY,
  agent_id TEXT NOT NULL,
  type TEXT NOT NULL,               -- deal/monthly/testimonial
  data TEXT NOT NULL,               -- JSON: æµ·æŠ¥æ•°æ®
  template_id TEXT,
  image_url TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (agent_id) REFERENCES users(id)
);
CREATE INDEX idx_poster_agent ON posters(agent_id);
```

### 19.8 ä¼šè¯è¡¨ (conversations)

```sql
CREATE TABLE conversations (
  id TEXT PRIMARY KEY,
  agent_id TEXT NOT NULL,
  channel TEXT NOT NULL,            -- wechat/wecom/douyin/xiaohongshu/sms
  customer_id TEXT,
  external_user_id TEXT,            -- æ¸ é“å†…ç”¨æˆ·ID
  external_user_name TEXT,
  last_message_at DATETIME,
  unread_count INTEGER DEFAULT 0,
  status TEXT DEFAULT 'active',     -- active/archived
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (agent_id) REFERENCES users(id),
  FOREIGN KEY (customer_id) REFERENCES customers(id)
);
CREATE INDEX idx_conv_agent_channel ON conversations(agent_id, channel);
CREATE INDEX idx_conv_last_msg ON conversations(last_message_at DESC);
```

### 19.9 æ¶ˆæ¯è¡¨ (messages)

```sql
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  conversation_id TEXT NOT NULL,
  direction TEXT NOT NULL,          -- inbound/outbound
  sender_id TEXT,
  content_type TEXT NOT NULL,       -- text/image/voice/video/link
  content_text TEXT,
  content_media_url TEXT,
  content_metadata TEXT,            -- JSON
  status TEXT DEFAULT 'received',   -- received/read/replied/archived
  is_important BOOLEAN DEFAULT FALSE,
  reply_to_id TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (conversation_id) REFERENCES conversations(id)
);
CREATE INDEX idx_msg_conv_date ON messages(conversation_id, created_at);
```

### 19.10 å¿«æ·å›å¤è¡¨ (quick_replies)

```sql
CREATE TABLE quick_replies (
  id TEXT PRIMARY KEY,
  agent_id TEXT NOT NULL,
  category TEXT NOT NULL,           -- greeting/quote/tour/followup
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  variables TEXT,                   -- JSONæ•°ç»„
  usage_count INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (agent_id) REFERENCES users(id)
);
CREATE INDEX idx_reply_agent_cat ON quick_replies(agent_id, category);
```

### 19.11 æé†’è¡¨ (reminders)

```sql
CREATE TABLE reminders (
  id TEXT PRIMARY KEY,
  agent_id TEXT NOT NULL,
  customer_id TEXT NOT NULL,
  type TEXT NOT NULL,               -- follow_up/tour/system
  message TEXT NOT NULL,
  priority TEXT DEFAULT 'medium',   -- high/medium/low
  scheduled_at DATETIME NOT NULL,
  is_read BOOLEAN DEFAULT FALSE,
  is_dismissed BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (agent_id) REFERENCES users(id),
  FOREIGN KEY (customer_id) REFERENCES customers(id)
);
CREATE INDEX idx_reminder_agent_date ON reminders(agent_id, scheduled_at);
CREATE INDEX idx_reminder_unread ON reminders(agent_id, is_read);
```

### 19.12 ERå…³ç³»å›¾

```
users â”€â”€1:Nâ”€â”€â–¶ projects
users â”€â”€1:Nâ”€â”€â–¶ customers
users â”€â”€1:1â”€â”€â–¶ agent_profiles
users â”€â”€1:Nâ”€â”€â–¶ tour_plans
users â”€â”€1:Nâ”€â”€â–¶ conversations

projects â”€â”€1:Nâ”€â”€â–¶ house_types
projects â”€â”€1:Nâ”€â”€â–¶ materials
projects â”€â”€1:Nâ”€â”€â–¶ generated_contents
projects â”€â”€1:Nâ”€â”€â–¶ tour_scripts
projects â”€â”€1:Nâ”€â”€â–¶ ppt_tasks

customers â”€â”€1:Nâ”€â”€â–¶ follow_up_records
customers â”€â”€1:Nâ”€â”€â–¶ tour_plans
customers â”€â”€1:Nâ”€â”€â–¶ conversations
customers â”€â”€1:Nâ”€â”€â–¶ reminders

conversations â”€â”€1:Nâ”€â”€â–¶ messages
```
